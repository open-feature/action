name: Test OpenFeature Manifest Compare Action

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:
  merge_group:

permissions:
  contents: read
  pull-requests: write  # Required for posting PR comments

jobs:
  test-action:
    runs-on: ubuntu-latest
    name: Test manifest comparison

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create sample local manifest
        run: |
          cat > openfeature.json << EOF
          {
            "flags": {
              "enableFeatureA": {
                "flagType": "boolean",
                "defaultValue": true,
                "description": "Controls whether Feature A is enabled - modified locally."
              },
              "localOnlyFlag": {
                "flagType": "string",
                "defaultValue": "Local only value",
                "description": "A flag that only exists locally."
              }
            }
          }
          EOF

      - name: Test action with sample upstream
        uses: ./
        id: compare-manifests
        with:
          against: 'https://raw.githubusercontent.com/open-feature/cli/refs/heads/main/sample/sample_manifest.json'
          manifest: 'openfeature.json'
          strict: false
          post-pr-comment: false

      - name: Display comparison results
        run: |
          echo "::notice::Has differences: ${{ steps.compare-manifests.outputs.has-differences }}"
          echo "::notice::Summary: ${{ steps.compare-manifests.outputs.summary }}"

      - name: Test with strict mode enabled
        uses: ./
        id: compare-with-fail
        continue-on-error: true
        with:
          against: 'https://raw.githubusercontent.com/open-feature/cli/refs/heads/main/sample/sample_manifest.json'
          manifest: 'openfeature.json'
          strict: true
          post-pr-comment: false
          against-manifest-path: 'against-test.json'

      - name: Test error handling - missing local file
        uses: ./
        id: test-missing-local
        continue-on-error: true
        with:
          against: 'https://raw.githubusercontent.com/open-feature/cli/refs/heads/main/sample/sample_manifest.json'
          manifest: 'nonexistent.yml'
          post-pr-comment: false

      - name: Verify error handling worked
        run: |
          if [ "${{ steps.test-missing-local.outcome }}" != "failure" ]; then
            echo "::error::Expected test-missing-local to fail but it didn't"
            exit 1
          fi
          echo "::notice::Error handling test passed - action correctly failed with missing local file"

      - name: Test error handling - invalid remote against URL
        uses: ./
        id: test-invalid-against
        continue-on-error: true
        with:
          against: 'https://httpbin.org/status/404'
          manifest: 'flags.json'
          post-pr-comment: false

      - name: Verify invalid against URL error handling
        run: |
          if [ "${{ steps.test-invalid-against.outcome }}" != "failure" ]; then
            echo "::error::Expected test-invalid-against to fail but it didn't"
            exit 1
          fi
          echo "::notice::Error handling test passed - action correctly failed with invalid against URL"

      - name: Test error handling - authentication required (401)
        uses: ./
        id: test-auth-required
        continue-on-error: true
        with:
          against: 'https://httpbin.org/status/401'
          manifest: 'flags.json'
          post-pr-comment: false

      - name: Verify authentication error handling
        run: |
          if [ "${{ steps.test-auth-required.outcome }}" != "failure" ]; then
            echo "::error::Expected test-auth-required to fail but it didn't"
            exit 1
          fi
          echo "::notice::Error handling test passed - action correctly failed with 401 authentication error"

      - name: Test error handling - invalid remote manifest URL
        uses: ./
        id: test-invalid-manifest
        continue-on-error: true
        with:
          manifest: 'https://httpbin.org/status/500'
          against: 'flags.json'
          post-pr-comment: false

      - name: Verify invalid manifest URL error handling
        run: |
          if [ "${{ steps.test-invalid-manifest.outcome }}" != "failure" ]; then
            echo "::error::Expected test-invalid-manifest to fail but it didn't"
            exit 1
          fi
          echo "::notice::Error handling test passed - action correctly failed with invalid manifest URL"

  test-yaml-parsing:
    runs-on: ubuntu-latest
    name: Test YAML output parsing

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create test manifest with differences
        run: |
          cat > test-manifest.json << EOF
          {
            "flags": {
              "testFlag": {
                "flagType": "string",
                "defaultValue": "different-value",
                "description": "A test flag with different value."
              },
              "localOnlyFlag": {
                "flagType": "boolean",
                "defaultValue": true,
                "description": "Flag only in local manifest."
              }
            }
          }
          EOF

      - name: Test YAML output and parsing
        uses: ./
        id: yaml-test
        with:
          against: 'https://raw.githubusercontent.com/open-feature/cli/refs/heads/main/sample/sample_manifest.json'
          manifest: 'test-manifest.json'
          post-pr-comment: false
          
      - name: Verify YAML parsing worked
        run: |
          echo "Has differences: ${{ steps.yaml-test.outputs.has-differences }}"
          echo "Summary: ${{ steps.yaml-test.outputs.summary }}"
          echo "Raw output:"
          echo "${{ steps.yaml-test.outputs.comparison-result }}"

  test-manifest-differences:
    runs-on: ubuntu-latest
    name: Test various manifest difference scenarios
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Test scenario - Flags added locally
        run: |
          echo "::notice::Testing scenario where local has additional flags"
          
          # Create local manifest with extra flags
          cat > local-added.json << EOF
          {
            "flags": {
              "existingFlag": {
                "flagType": "boolean",
                "defaultValue": true,
                "description": "Flag that exists in both"
              },
              "newLocalFlag": {
                "flagType": "string",
                "defaultValue": "local-only",
                "description": "Flag added locally, not in remote"
              },
              "anotherNewFlag": {
                "flagType": "number",
                "defaultValue": 42,
                "description": "Another flag only in local"
              }
            }
          }
          EOF
          
      - name: Compare - local has additional flags
        uses: ./
        id: test-added
        with:
          against: 'https://raw.githubusercontent.com/open-feature/cli/refs/heads/main/sample/sample_manifest.json'
          manifest: 'local-added.json'
          post-pr-comment: false
          
      - name: Display results for added flags
        run: |
          echo "Has differences: ${{ steps.test-added.outputs.has-differences }}"
          echo "Comparison output:"
          echo "${{ steps.test-added.outputs.comparison-result }}"

      - name: Test scenario - Flags removed locally
        run: |
          echo "::notice::Testing scenario where local is missing flags that exist in remote"
          
          # Create minimal local manifest (missing many remote flags)
          cat > local-removed.json << EOF
          {
            "flags": {
              "exampleBool": {
                "flagType": "boolean",
                "defaultValue": false,
                "description": "One of the few flags kept locally"
              }
            }
          }
          EOF
          
      - name: Compare - local missing flags
        uses: ./
        id: test-removed
        with:
          against: 'https://raw.githubusercontent.com/open-feature/cli/refs/heads/main/sample/sample_manifest.json'
          manifest: 'local-removed.json'
          post-pr-comment: false
          
      - name: Display results for removed flags
        run: |
          echo "Has differences: ${{ steps.test-removed.outputs.has-differences }}"
          echo "Summary: ${{ steps.test-removed.outputs.summary }}"

      - name: Test scenario - Modified flag values
        run: |
          echo "::notice::Testing scenario where flags exist in both but with different values"
          
          # Create local manifest with modified values
          cat > local-modified.json << EOF
          {
            "flags": {
              "exampleBool": {
                "flagType": "boolean",
                "defaultValue": true,
                "description": "Modified: was false, now true"
              },
              "exampleStr": {
                "flagType": "string",
                "defaultValue": "production-value",
                "description": "Modified: different default value"
              },
              "exampleNum": {
                "flagType": "number",
                "defaultValue": 999,
                "description": "Modified: was 10, now 999"
              }
            }
          }
          EOF

      - name: Compare - modified flag values
        uses: ./
        id: test-modified
        with:
          against: 'https://raw.githubusercontent.com/open-feature/cli/refs/heads/main/sample/sample_manifest.json'
          manifest: 'local-modified.json'
          post-pr-comment: false

      - name: Display results for modified flags
        run: |
          echo "Has differences: ${{ steps.test-modified.outputs.has-differences }}"
          echo "Comparison output:"
          echo "${{ steps.test-modified.outputs.comparison-result }}"

      - name: Test scenario - Identical manifests
        run: |
          echo "::notice::Testing scenario where manifests are identical"
          
          # Download the remote manifest to use as local
          curl -s https://raw.githubusercontent.com/open-feature/cli/refs/heads/main/sample/sample_manifest.json > identical.json

      - name: Compare - identical manifests
        uses: ./
        id: test-identical
        with:
          against: 'https://raw.githubusercontent.com/open-feature/cli/refs/heads/main/sample/sample_manifest.json'
          manifest: 'identical.json'
          post-pr-comment: false

      - name: Display results for identical manifests
        run: |
          echo "Has differences: ${{ steps.test-identical.outputs.has-differences }}"
          echo "Summary: ${{ steps.test-identical.outputs.summary }}"
          if [ "${{ steps.test-identical.outputs.has-differences }}" = "true" ]; then
            echo "::error::Expected no differences for identical manifests!"
            exit 1
          fi
          echo "✅ Correctly identified identical manifests"

      - name: Test scenario - Complex mixed changes
        run: |
          echo "::notice::Testing scenario with added, removed, and modified flags"
          
          cat > local-mixed.json << EOF
          {
            "flags": {
              "exampleBool": {
                "flagType": "boolean",
                "defaultValue": true,
                "description": "Modified from original"
              },
              "brandNewFeature": {
                "flagType": "boolean", 
                "defaultValue": false,
                "description": "Added: New feature flag"
              },
              "anotherNewFlag": {
                "flagType": "string",
                "defaultValue": "innovation",
                "description": "Added: Another new flag"
              }
            }
          }
          EOF
          echo "Note: This manifest has modified exampleBool, added new flags, and removed exampleStr and exampleNum"

      - name: Compare - mixed changes
        uses: ./
        id: test-mixed
        with:
          against: 'https://raw.githubusercontent.com/open-feature/cli/refs/heads/main/sample/sample_manifest.json'
          manifest: 'local-mixed.json'
          post-pr-comment: false

      - name: Display results for mixed changes
        run: |
          echo "Has differences: ${{ steps.test-mixed.outputs.has-differences }}"
          echo "YAML output:"
          echo "${{ steps.test-mixed.outputs.comparison-result }}"

  test-cli-versions:
    runs-on: ubuntu-latest
    name: Test different CLI versions
    strategy:
      matrix:
        cli-version: ['latest', 'v0.3.6']

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create test manifest
        run: |
          cat > version-test.json << EOF
          {
            "flags": {
              "versionTest": {
                "flagType": "boolean",
                "defaultValue": true,
                "description": "A flag for testing CLI versions."
              }
            }
          }
          EOF

      - name: Test with CLI version ${{ matrix.cli-version }}
        uses: ./
        with:
          against: 'https://raw.githubusercontent.com/open-feature/cli/refs/heads/main/sample/sample_manifest.json'
          manifest: 'version-test.json'
          cli-version: ${{ matrix.cli-version }}
          post-pr-comment: false

  test-git-mode:
    runs-on: ubuntu-latest
    name: Test Git branch comparison mode
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history for branch comparison
      
      - name: Create sample manifest on current branch
        run: |
          cat > flags.json << EOF
          {
            "flags": {
              "gitModeTest": {
                "flagType": "boolean",
                "defaultValue": true,
                "description": "Test flag for git mode"
              },
              "newFeatureFlag": {
                "flagType": "string",
                "defaultValue": "feature-branch-value",
                "description": "Flag added on feature branch"
              }
            }
          }
          EOF
      
      - name: Test git mode with explicit base branch (should use main)
        uses: ./
        id: git-mode-explicit
        with:
          base-branch: main
          manifest: flags.json
          strict: false
          post-pr-comment: false
        continue-on-error: true
        
      - name: Display git mode results
        run: |
          echo "::notice::Git mode test completed"
          echo "Has differences: ${{ steps.git-mode-explicit.outputs.has-differences }}"
          echo "Summary: ${{ steps.git-mode-explicit.outputs.summary }}"
          
      - name: Test minimal git mode (no against specified)
        uses: ./
        id: git-mode-minimal
        with:
          manifest: flags.json
          strict: false
          post-pr-comment: false
        continue-on-error: true
        
      - name: Test git mode with different path mapping
        run: |
          # Create a manifest in a subdirectory
          mkdir -p config
          cat > config/feature-flags.json << EOF
          {
            "flags": {
              "pathMappingTest": {
                "flagType": "number",
                "defaultValue": 123,
                "description": "Test different path mapping"
              }
            }
          }
          EOF
        
      - name: Test git mode with path mapping
        uses: ./
        id: git-mode-path-mapping
        with:
          manifest: config/feature-flags.json
          against: flags.json  # Compare different paths
          base-branch: main
          strict: false
          post-pr-comment: false
        continue-on-error: true

  test-protocol-detection:
    runs-on: ubuntu-latest
    name: Test various URL protocol detection
    
    strategy:
      matrix:
        protocol:
          - url: 'https://raw.githubusercontent.com/open-feature/cli/refs/heads/main/sample/sample_manifest.json'
            description: 'HTTPS URL'
          - url: 'http://httpbin.org/json'
            description: 'HTTP URL'
          - url: 'file:///etc/hosts'
            description: 'File protocol'
        
    steps:
      - name: Checkout repository  
        uses: actions/checkout@v4
        
      - name: Create test manifest
        run: |
          cat > protocol-test.json << EOF
          {
            "flags": {
              "protocolTest": {
                "flagType": "string", 
                "defaultValue": "test-value",
                "description": "Testing protocol detection for ${{ matrix.protocol.description }}"
              }
            }
          }
          EOF
          
      - name: Test ${{ matrix.protocol.description }}
        uses: ./
        continue-on-error: true
        with:
          against: ${{ matrix.protocol.url }}
          manifest: protocol-test.json
          strict: false
          post-pr-comment: false

  test-remote-to-remote:
    runs-on: ubuntu-latest
    name: Test remote-to-remote manifest comparison
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Test remote manifest against remote against
        uses: ./
        id: remote-to-remote
        with:
          manifest: 'https://raw.githubusercontent.com/open-feature/cli/refs/heads/main/sample/sample_manifest.json'
          against: 'https://raw.githubusercontent.com/open-feature/cli/refs/heads/main/sample/sample_manifest.json'
          post-pr-comment: false
          
      - name: Verify identical remote manifests
        run: |
          echo "Has differences: ${{ steps.remote-to-remote.outputs.has-differences }}"
          echo "Local manifest path: ${{ steps.remote-to-remote.outputs.local-manifest-path }}"
          echo "Against manifest path: ${{ steps.remote-to-remote.outputs.against-manifest-path }}"
          
          if [ "${{ steps.remote-to-remote.outputs.has-differences }}" = "true" ]; then
            echo "::error::Expected no differences for identical remote manifests!"
            exit 1
          fi
          echo "✅ Correctly identified identical remote manifests"
          
      - name: Test different remote manifests
        run: |
          # Create a different manifest to upload somewhere accessible
          cat > different-manifest.json << EOF
          {
            "flags": {
              "remoteTestFlag": {
                "flagType": "boolean",
                "defaultValue": true,
                "description": "A different flag for remote testing"
              }
            }
          }
          EOF
          
      - name: Test remote vs different remote (simulated)
        uses: ./
        id: different-remotes
        with:
          manifest: 'https://raw.githubusercontent.com/open-feature/cli/refs/heads/main/sample/sample_manifest.json'
          against: different-manifest.json  # Use local file as "against" to simulate different remote
          post-pr-comment: false
          
      - name: Verify different manifests detected
        run: |
          echo "Has differences: ${{ steps.different-remotes.outputs.has-differences }}"
          echo "Summary: ${{ steps.different-remotes.outputs.summary }}"
          
          if [ "${{ steps.different-remotes.outputs.has-differences }}" = "false" ]; then
            echo "::error::Expected differences between different manifests!"
            exit 1
          fi
          echo "✅ Correctly detected differences between remote and local manifests"

  test-remote-perspective:
    runs-on: ubuntu-latest
    name: Test remote comparison perspective (what will change)

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create local manifest with new flag
        run: |
          cat > local-with-new-flag.json << EOF
          {
            "flags": {
              "exampleBool": {
                "flagType": "boolean",
                "defaultValue": true
              },
              "newFlagAddedLocally": {
                "flagType": "boolean",
                "defaultValue": true
              }
            }
          }
          EOF

      - name: Test remote comparison perspective
        id: test-perspective
        uses: ./
        with:
          manifest: local-with-new-flag.json
          against: 'https://raw.githubusercontent.com/open-feature/cli/refs/heads/main/sample/sample_manifest.json'
          post-pr-comment: false

      - name: Verify perspective is correct
        run: |
          echo "Testing that the perspective shows 'what will change in remote'"
          echo "Local manifest has a new flag that remote doesn't have"
          echo "Expected: Should show as 'will be ADDED to remote' (positive count in ADD_COUNT)"
          echo ""
          echo "Has differences: ${{ steps.test-perspective.outputs.has-differences }}"
          echo "Summary: ${{ steps.test-perspective.outputs.summary }}"
          echo ""
          echo "Comparison result:"
          echo "${{ steps.test-perspective.outputs.comparison-result }}"

          # The test passes if differences are detected
          # The actual verification of correct perspective happens in the summary/PR comment text
          # which is checked manually or via the step summary
          if [ "${{ steps.test-perspective.outputs.has-differences }}" != "true" ]; then
            echo "::error::Expected differences to be detected!"
            exit 1
          fi

          echo "✅ Remote comparison perspective test completed"
          echo "::notice::Check the step summary to verify the perspective is 'what will change in remote'"
