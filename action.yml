name: 'OpenFeature Manifest Compare'
description: 'Compare flag manifests between current branch and upstream source using OpenFeature CLI'
author: 'OpenFeature'

branding:
  icon: 'git-branch'
  color: 'blue'

inputs:
  against:
    description: 'URL/remote source OR local path for git comparison (optional for PR workflows)'
    required: false
  manifest:
    description: 'Path to local flag manifest file OR URL to remote manifest'
    required: false
    default: 'flags.json'
  base-branch:
    description: 'Base branch for git comparison (auto-detected in PRs)'
    required: false
  auth-token:
    description: 'Authentication token for accessing the against source (optional)'
    required: false
  manifest-auth-token:
    description: 'Authentication token for accessing the manifest source (optional)'
    required: false
  cli-version:
    description: 'OpenFeature CLI version to use'
    required: false
    default: 'latest'
  against-manifest-path:
    description: 'Path where the manifest from the against source will be saved'
    required: false
    default: 'against-flags.json'
  strict:
    description: 'Strict mode - fail the action if differences are found'
    required: false
    default: 'false'
  post-pr-comment:
    description: 'Post a comment on the PR when differences are detected'
    required: false
    default: 'true'

outputs:
  has-differences:
    description: 'Whether differences were found between manifests'
    value: ${{ steps.compare.outputs.has-differences }}
  comparison-result:
    description: 'Raw comparison output from OpenFeature CLI'
    value: ${{ steps.compare.outputs.comparison-result }}
  against-manifest-path:
    description: 'Path to the downloaded manifest from the against source'
    value: ${{ steps.compare.outputs.against-manifest-path }}
  local-manifest-path:
    description: 'Path to the local manifest file (original path or downloaded from URL)'
    value: ${{ steps.compare.outputs.local-manifest-path }}
  summary:
    description: 'Human-readable summary of changes'
    value: ${{ steps.compare.outputs.summary }}

runs:
  using: 'composite'
  steps:
    - name: Setup and Install CLI
      shell: bash
      run: |
        echo "::group::Installing OpenFeature CLI"

        # Define reusable functions
        is_url() {
          [[ "$1" =~ :// ]] || [[ "$1" =~ ^[^/]+:[^/] ]]
        }

        get_target_branch() {
          if [ -n "${{ github.base_ref }}" ]; then
            echo "${{ github.base_ref }}"
          elif [ -n "${{ inputs.base-branch }}" ]; then
            echo "${{ inputs.base-branch }}"
          else
            echo "main"
          fi
        }

        pull_manifest() {
          local source_url="$1"
          local output_path="$2"
          local auth_token="$3"
          local description="$4"
          
          echo "::notice::Pulling $description from: $source_url"
          
          local pull_cmd="$CLI_PATH pull --flag-source-url \"$source_url\" --manifest \"$output_path\" --no-prompt"
          
          if [ -n "$auth_token" ]; then
            echo "::notice::Using authentication token for $description"
            pull_cmd="$pull_cmd --auth-token \"$auth_token\""
          fi
          
          if ! eval $pull_cmd; then
            echo "::error::Failed to pull $description from $source_url"
            return 1
          fi
          
          echo "::notice::$description downloaded to $output_path"
        }

        fetch_git_manifest() {
          local target_branch="$1"
          local remote_path="$2"
          local output_path="$3"
          
          echo "::notice::Fetching manifest from git branch $target_branch:$remote_path"
          
          # Verify the target branch exists
          if ! git rev-parse --verify "origin/$target_branch" >/dev/null 2>&1; then
            if ! git rev-parse --verify "$target_branch" >/dev/null 2>&1; then
              echo "::error::Target branch '$target_branch' not found in local or remote repository"
              return 1
            fi
          fi
          
          # Fetch manifest from target branch
          if ! git show "$target_branch:$remote_path" > "$output_path" 2>/dev/null; then
            if ! git show "origin/$target_branch:$remote_path" > "$output_path" 2>/dev/null; then
              echo "::error::Failed to fetch manifest '$remote_path' from branch '$target_branch'"
              echo "::error::Make sure the manifest file exists in the target branch"
              return 1
            fi
          fi
          
          echo "::notice::Successfully fetched manifest from branch $target_branch"
        }

        generate_config_table() {
          local manifest_path="$1"
          
          echo "| Parameter | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Local Manifest** | \`$manifest_path\` |" >> $GITHUB_STEP_SUMMARY
          
          # Determine and display the against source
          if is_url "${{ inputs.against }}"; then
            echo "| **Against Source** | \`${{ inputs.against }}\` |" >> $GITHUB_STEP_SUMMARY
          else
            # Git mode - show branch and path
            local target_branch=$(get_target_branch)
            local remote_path="${{ inputs.against }}"
            if [ -z "$remote_path" ]; then
              remote_path="${{ inputs.manifest }}"
            fi
            echo "| **Against Source** | Branch \`$target_branch\` at \`$remote_path\` |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "| **Strict Mode** | \`${{ inputs.strict }}\` |" >> $GITHUB_STEP_SUMMARY
        }

        # Export functions for use in subsequent steps
        declare -f is_url get_target_branch pull_manifest fetch_git_manifest generate_config_table > /tmp/action_functions.sh

        # Install CLI
        if [ "${{ inputs.cli-version }}" = "latest" ]; then
          VERSION=$(curl -s https://api.github.com/repos/open-feature/cli/releases/latest | grep -oP '"tag_name": "\K(.*)(?=")')
        else
          VERSION="${{ inputs.cli-version }}"
        fi

        echo "::notice::Installing OpenFeature CLI version: $VERSION"
        go install github.com/open-feature/cli/cmd/openfeature@${VERSION} 2>&1
        echo "$HOME/go/bin" >> $GITHUB_PATH

        # Set CLI path for reuse
        CLI_PATH="$HOME/go/bin/openfeature"
        echo "CLI_PATH=$CLI_PATH" >> $GITHUB_ENV

        # Verify installation
        $CLI_PATH version
        echo "::endgroup::"

    - name: Resolve Manifests
      shell: bash
      run: |
        echo "::group::Resolving manifests"

        # Source our functions
        source /tmp/action_functions.sh

        # Resolve local manifest
        if is_url "${{ inputs.manifest }}"; then
          echo "::notice::Remote manifest URL detected: ${{ inputs.manifest }}"
          LOCAL_MANIFEST_PATH="local-manifest.json"
          pull_manifest "${{ inputs.manifest }}" "$LOCAL_MANIFEST_PATH" "${{ inputs.manifest-auth-token }}" "manifest" || exit 1
        else
          echo "::notice::Local manifest file detected: ${{ inputs.manifest }}"
          LOCAL_MANIFEST_PATH="${{ inputs.manifest }}"
          if [ ! -f "$LOCAL_MANIFEST_PATH" ]; then
            echo "::error::Local manifest file '$LOCAL_MANIFEST_PATH' not found"
            exit 1
          fi
        fi

        # Resolve against manifest
        if is_url "${{ inputs.against }}"; then
          echo "::notice::Remote against URL detected: ${{ inputs.against }}"
          pull_manifest "${{ inputs.against }}" "${{ inputs.against-manifest-path }}" "${{ inputs.auth-token }}" "against manifest" || exit 1
        elif [ -n "${{ inputs.against }}" ] && [ -f "${{ inputs.against }}" ]; then
          # Against is a local file - copy it to the expected location
          echo "::notice::Local against file detected: ${{ inputs.against }}"
          cp "${{ inputs.against }}" "${{ inputs.against-manifest-path }}"
          echo "::notice::Copied local against file to ${{ inputs.against-manifest-path }}"
        elif [ -n "${{ inputs.against }}" ]; then
          # Against is specified but not a URL or existing local file - treat as git path
          echo "::notice::Git mode detected for against source"
          target_branch=$(get_target_branch)
          remote_path="${{ inputs.against }}"
          echo "::notice::Comparing different paths - Base: $remote_path, Local: ${{ inputs.manifest }}"
          fetch_git_manifest "$target_branch" "$remote_path" "${{ inputs.against-manifest-path }}" || exit 1
        else
          # No against specified - use same manifest path from target branch
          echo "::notice::Git mode detected for against source"
          target_branch=$(get_target_branch)
          remote_path="${{ inputs.manifest }}"
          echo "::notice::Comparing same manifest path between branches: $remote_path"
          fetch_git_manifest "$target_branch" "$remote_path" "${{ inputs.against-manifest-path }}" || exit 1
        fi

        # Verify against manifest exists
        if [ ! -f "${{ inputs.against-manifest-path }}" ]; then
          echo "::error::Against manifest file not found at ${{ inputs.against-manifest-path }}"
          exit 1
        fi

        # Detect if we're comparing to a remote URL (for correct comparison perspective)
        if is_url "${{ inputs.against }}"; then
          REMOTE_COMPARISON="true"
          echo "::notice::Remote comparison mode enabled - will show changes from remote perspective"
        else
          REMOTE_COMPARISON="false"
        fi

        # Export paths and flags for comparison step
        echo "LOCAL_MANIFEST_PATH=$LOCAL_MANIFEST_PATH" >> $GITHUB_ENV
        echo "REMOTE_COMPARISON=$REMOTE_COMPARISON" >> $GITHUB_ENV
        MANIFEST_SIZE=$(wc -c < "${{ inputs.against-manifest-path }}")
        echo "::notice::Against manifest saved to ${{ inputs.against-manifest-path }} (${MANIFEST_SIZE} bytes)"
        echo "::notice::Using local manifest at: $LOCAL_MANIFEST_PATH"
        echo "::endgroup::"

    - name: Compare manifests
      id: compare
      shell: bash
      run: |
        echo "::group::Comparing manifests"

        # Create output directory
        mkdir -p comparison-output

        # Determine comparison parameters based on mode
        # For remote comparisons, we swap the parameters so the output shows
        # "what will change in the remote" rather than "what's different in local"
        if [ "$REMOTE_COMPARISON" = "true" ]; then
          echo "::notice::Using remote comparison perspective (showing changes that will be applied to remote)"
          MANIFEST_PARAM="${{ inputs.against-manifest-path }}"
          AGAINST_PARAM="$LOCAL_MANIFEST_PATH"
        else
          echo "::notice::Using git comparison perspective (showing changes in current branch)"
          MANIFEST_PARAM="$LOCAL_MANIFEST_PATH"
          AGAINST_PARAM="${{ inputs.against-manifest-path }}"
        fi

        # Run comparison
        set +e
        COMPARE_OUTPUT=$($CLI_PATH compare --manifest "$MANIFEST_PARAM" --against "$AGAINST_PARAM" --output yaml 2>&1)
        COMPARE_EXIT_CODE=$?
        set -e

        # Save raw output
        echo "$COMPARE_OUTPUT" > comparison-output/raw-output.txt

        # Determine differences
        HAS_DIFFERENCES="false"
        if echo "$COMPARE_OUTPUT" | grep -q "No differences found between the manifests"; then
          HAS_DIFFERENCES="false"
        elif [ -n "$COMPARE_OUTPUT" ]; then
          HAS_DIFFERENCES="true"
        fi

        # Set outputs
        echo "has-differences=$HAS_DIFFERENCES" >> $GITHUB_OUTPUT
        echo "comparison-result<<EOF" >> $GITHUB_OUTPUT
        echo "$COMPARE_OUTPUT" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        echo "against-manifest-path=${{ inputs.against-manifest-path }}" >> $GITHUB_OUTPUT
        echo "local-manifest-path=$LOCAL_MANIFEST_PATH" >> $GITHUB_OUTPUT

        # Generate summary
        if [ "$HAS_DIFFERENCES" = "true" ]; then
          SUMMARY="üîç Flag manifest differences detected between local and against sources"
          echo "::warning::Differences found between local and against manifests"
        else
          SUMMARY="‚úÖ No differences found between local and against flag manifests"
          echo "::notice::Manifests are in sync"
        fi

        echo "summary<<EOF" >> $GITHUB_OUTPUT
        echo "$SUMMARY" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

        echo "::endgroup::"

    - name: Generate Summary
      shell: bash
      run: |
        echo "::group::Generating summary"

        # Source our functions
        source /tmp/action_functions.sh

        # Determine comparison type
        if is_url "${{ inputs.against }}"; then
          COMPARISON_TITLE="## üåê Remote Push Preview"
          COMPARISON_SUBTITLE="Showing what will change in the remote flag service when changes are pushed"
          IS_REMOTE_URL="true"
        else
          target_branch=$(get_target_branch)
          COMPARISON_TITLE="## üîÄ Git Branch Comparison"
          COMPARISON_SUBTITLE="Comparing against $target_branch branch"
          IS_REMOTE_URL="false"
        fi

        # Header
        echo "$COMPARISON_TITLE" >> $GITHUB_STEP_SUMMARY
        echo "*$COMPARISON_SUBTITLE*" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        HAS_DIFFERENCES="${{ steps.compare.outputs.has-differences }}"

        if [ "$HAS_DIFFERENCES" = "true" ]; then
          # Status banner
          echo "> [!WARNING]" >> $GITHUB_STEP_SUMMARY
          if [ "$IS_REMOTE_URL" = "true" ]; then
            echo "> **Changes Will Be Applied** - The following changes will be made to the remote flag service when pushed" >> $GITHUB_STEP_SUMMARY
            echo "> **Remote Source:** \`${{ inputs.against }}\`" >> $GITHUB_STEP_SUMMARY
          else
            target_branch=$(get_target_branch)
            echo "> **Changes Detected** - This branch modifies the flag manifest compared to $target_branch" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Parse YAML and generate change summary
          if [ -f "comparison-output/raw-output.txt" ]; then
            RAW_YAML=$(cat comparison-output/raw-output.txt)
            
            # Count changes
            RAW_ADD_COUNT=$(echo "$RAW_YAML" | sed -n '/^additions:/,/^[a-z]/p' | grep -c "^    - type:" || true)
            RAW_REMOVE_COUNT=$(echo "$RAW_YAML" | sed -n '/^removals:/,/^[a-z]/p' | grep -c "^    - type:" || true)
            MODIFY_COUNT=$(echo "$RAW_YAML" | sed -n '/^modifications:/,/^[a-z]/p' | grep -c "^    - type:" || true)

            # For remote comparisons, we swapped the CLI parameters, so we need to swap the interpretation
            # CLI's "additions" (in remote, not in local) = will be removed from remote
            # CLI's "removals" (in local, not in remote) = will be added to remote
            if [ "$REMOTE_COMPARISON" = "true" ]; then
              ADD_COUNT=$RAW_REMOVE_COUNT
              REMOVE_COUNT=$RAW_ADD_COUNT
            else
              ADD_COUNT=$RAW_ADD_COUNT
              REMOVE_COUNT=$RAW_REMOVE_COUNT
            fi

            # Export for PR comments
            echo "ADD_COUNT=$ADD_COUNT" >> $GITHUB_ENV
            echo "REMOVE_COUNT=$REMOVE_COUNT" >> $GITHUB_ENV
            echo "MODIFY_COUNT=$MODIFY_COUNT" >> $GITHUB_ENV
            echo "TOTAL_CHANGES=$((ADD_COUNT + REMOVE_COUNT + MODIFY_COUNT))" >> $GITHUB_ENV
            
            # Summary table
            echo "## üìä Change Summary" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Change Type | Count | Description |" >> $GITHUB_STEP_SUMMARY
            echo "|-------------|-------|-------------|" >> $GITHUB_STEP_SUMMARY

            if [ "$REMOTE_COMPARISON" = "true" ]; then
              echo "| üü¢ **Additions** | **$ADD_COUNT** | Flags that will be added to remote |" >> $GITHUB_STEP_SUMMARY
              echo "| üî¥ **Removals** | **$REMOVE_COUNT** | Flags that will be removed from remote |" >> $GITHUB_STEP_SUMMARY
              echo "| üü° **Modifications** | **$MODIFY_COUNT** | Flags that will be modified in remote |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| üü¢ **Additions** | **$ADD_COUNT** | Flags added in this branch |" >> $GITHUB_STEP_SUMMARY
              echo "| üî¥ **Removals** | **$REMOVE_COUNT** | Flags removed in this branch |" >> $GITHUB_STEP_SUMMARY
              echo "| üü° **Modifications** | **$MODIFY_COUNT** | Flags modified in this branch |" >> $GITHUB_STEP_SUMMARY
            fi

            echo "| **Total Changes** | **$((ADD_COUNT + REMOVE_COUNT + MODIFY_COUNT))** | Overall differences detected |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Build change details for PR comment
            # Note: For remote comparisons, we swapped the counts, so we also need to swap which YAML sections we read
            CHANGE_DETAILS=""
            if [ $ADD_COUNT -gt 0 ]; then
              if [ "$REMOTE_COMPARISON" = "true" ]; then
                CHANGE_DETAILS="${CHANGE_DETAILS}### üü¢ Flags That Will Be Added ($ADD_COUNT)\n"
                ADD_LIST=$(echo "$RAW_YAML" | sed -n '/^removals:/,/^[a-z]/p' | grep "^      path:" | sed 's/^      path: flags\./- üü¢ `/' | sed 's/$/`/')
              else
                CHANGE_DETAILS="${CHANGE_DETAILS}### üü¢ Flags Added ($ADD_COUNT)\n"
                ADD_LIST=$(echo "$RAW_YAML" | sed -n '/^additions:/,/^[a-z]/p' | grep "^      path:" | sed 's/^      path: flags\./- üü¢ `/' | sed 's/$/`/')
              fi
              CHANGE_DETAILS="${CHANGE_DETAILS}${ADD_LIST}\n\n"
            fi
            if [ $REMOVE_COUNT -gt 0 ]; then
              if [ "$REMOTE_COMPARISON" = "true" ]; then
                CHANGE_DETAILS="${CHANGE_DETAILS}### üî¥ Flags That Will Be Removed ($REMOVE_COUNT)\n"
                REMOVE_LIST=$(echo "$RAW_YAML" | sed -n '/^additions:/,/^[a-z]/p' | grep "^      path:" | sed 's/^      path: flags\./- üî¥ `/' | sed 's/$/`/')
              else
                CHANGE_DETAILS="${CHANGE_DETAILS}### üî¥ Flags Removed ($REMOVE_COUNT)\n"
                REMOVE_LIST=$(echo "$RAW_YAML" | sed -n '/^removals:/,/^[a-z]/p' | grep "^      path:" | sed 's/^      path: flags\./- üî¥ `/' | sed 's/$/`/')
              fi
              CHANGE_DETAILS="${CHANGE_DETAILS}${REMOVE_LIST}\n\n"
            fi
            if [ $MODIFY_COUNT -gt 0 ]; then
              if [ "$REMOTE_COMPARISON" = "true" ]; then
                CHANGE_DETAILS="${CHANGE_DETAILS}### üü° Flags That Will Be Modified ($MODIFY_COUNT)\n"
              else
                CHANGE_DETAILS="${CHANGE_DETAILS}### üü° Flags Modified ($MODIFY_COUNT)\n"
              fi
              MODIFY_LIST=$(echo "$RAW_YAML" | sed -n '/^modifications:/,/^[a-z]/p' | grep "^      path:" | sed 's/^      path: flags\./- üü° `/' | sed 's/$/`/')
              CHANGE_DETAILS="${CHANGE_DETAILS}${MODIFY_LIST}\n"
            fi
            
            # Export for PR comment
            echo "CHANGE_DETAILS<<EOF" >> $GITHUB_ENV
            echo -e "$CHANGE_DETAILS" >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
            
            # Configuration section
            echo "## Configuration" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "<details>" >> $GITHUB_STEP_SUMMARY
            echo "<summary>View configuration details</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            generate_config_table "$LOCAL_MANIFEST_PATH"
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Manifest diff
            echo "## üîÑ Manifest Diff" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "<details>" >> $GITHUB_STEP_SUMMARY
            echo "<summary>View unified diff between manifests</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```diff' >> $GITHUB_STEP_SUMMARY
            MANIFEST_DIFF=$(diff -u "$LOCAL_MANIFEST_PATH" "${{ inputs.against-manifest-path }}" | tail -n +3 || true)
            echo "$MANIFEST_DIFF" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Export diff for PR comment
            echo "MANIFEST_DIFF<<EOF" >> $GITHUB_ENV
            echo "$MANIFEST_DIFF" >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
            
            # Raw output
            echo "## üìÑ Raw Output" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "<details>" >> $GITHUB_STEP_SUMMARY
            echo "<summary>Click to expand raw YAML comparison output</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```yaml' >> $GITHUB_STEP_SUMMARY
            echo "$RAW_YAML" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
          fi
        else
          # Success case
          echo "> [!NOTE]" >> $GITHUB_STEP_SUMMARY
          if [ "$IS_REMOTE_URL" = "true" ]; then
            echo "> ‚úÖ **In Sync** - Your local manifest matches the remote flag service" >> $GITHUB_STEP_SUMMARY
            echo "> **Source:** \`${{ inputs.against }}\`" >> $GITHUB_STEP_SUMMARY
          else
            target_branch=$(get_target_branch)
            echo "> ‚úÖ **No Changes** - The flag manifest is identical to $target_branch branch" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üéâ Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$IS_REMOTE_URL" = "true" ]; then
            echo "Your local manifest matches the remote flag service. No changes will be applied when pushed. üöÄ" >> $GITHUB_STEP_SUMMARY
          else
            target_branch=$(get_target_branch)
            echo "No flag configuration changes in this branch compared to $target_branch. üöÄ" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Configuration section for success case
          echo "## Configuration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "<details>" >> $GITHUB_STEP_SUMMARY
          echo "<summary>View configuration details</summary>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          generate_config_table "$LOCAL_MANIFEST_PATH"
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "</details>" >> $GITHUB_STEP_SUMMARY
        fi

        # Footer
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        if [ "$IS_REMOTE_URL" = "true" ]; then
          echo "*üí° This preview shows what will change in the remote flag service when you push your local manifest*" >> $GITHUB_STEP_SUMMARY
        else
          echo "*üí° This comparison shows changes introduced in your branch compared to the target branch*" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "*Generated by [OpenFeature Manifest Compare Action](https://github.com/openfeature/action)*" >> $GITHUB_STEP_SUMMARY

        echo "::endgroup::"

    - name: Post PR comment
      if: |
        github.event_name == 'pull_request' &&
        steps.compare.outputs.has-differences == 'true' &&
        inputs.post-pr-comment == 'true'
      uses: marocchino/sticky-pull-request-comment@v2
      with:
        header: openfeature-manifest-compare-${{ github.job }}
        message: |
          ## üöÄ OpenFeature Manifest Comparison (${{ github.job }})

          > [!WARNING]
          ${{ (contains(inputs.against, '://') || contains(inputs.against, ':')) &&
              format('> **Remote Push Preview** - The following changes will be applied to the remote flag service (`{0}`) when your manifest is pushed', inputs.against) ||
              format('> **Git Changes Detected** - Your feature flag manifest has changes compared to the {0} branch',
                     github.base_ref || inputs.base-branch || 'main') }}

          ### üìä Change Summary

          | Change Type | Count | Description |
          |-------------|-------|-------------|
          | üü¢ **Additions** | **${{ env.ADD_COUNT }}** | ${{ (contains(inputs.against, '://') || contains(inputs.against, ':')) && 'Flags that will be added to remote' || 'Flags added in this branch' }} |
          | üî¥ **Removals** | **${{ env.REMOVE_COUNT }}** | ${{ (contains(inputs.against, '://') || contains(inputs.against, ':')) && 'Flags that will be removed from remote' || 'Flags removed in this branch' }} |
          | üü° **Modifications** | **${{ env.MODIFY_COUNT }}** | ${{ (contains(inputs.against, '://') || contains(inputs.against, ':')) && 'Flags that will be modified in remote' || 'Flags modified in this branch' }} |
          | **Total** | **${{ env.TOTAL_CHANGES }}** | Total differences |

          <details>
          <summary>üìã View detailed changes</summary>

          ${{ env.CHANGE_DETAILS }}

          </details>

          <details>
          <summary>üîÑ View manifest diff</summary>

          ```diff
          ${{ env.MANIFEST_DIFF }}
          ```

          </details>

          ---
          ${{ (contains(inputs.against, '://') || contains(inputs.against, ':')) &&
              '*üí° This preview shows what will change in the remote flag service when you push your local manifest*' ||
              '*üìù This comparison shows changes introduced in this PR*' }}

          *This comment is automatically updated on each push*

    - name: Delete PR comment if no differences
      if: |
        github.event_name == 'pull_request' &&
        steps.compare.outputs.has-differences == 'false' &&
        inputs.post-pr-comment == 'true'
      uses: marocchino/sticky-pull-request-comment@v2
      with:
        header: openfeature-manifest-compare-${{ github.job }}
        delete: true

    - name: Handle failure condition
      shell: bash
      run: |
        HAS_DIFFERENCES="${{ steps.compare.outputs.has-differences }}"
        STRICT_MODE="${{ inputs.strict }}"

        if [ "$HAS_DIFFERENCES" = "true" ] && [ "$STRICT_MODE" = "true" ]; then
          echo "::error::Manifest differences detected in strict mode"
          exit 1
        fi
