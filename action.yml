name: 'OpenFeature Manifest Compare'
description: 'Compare flag manifests between current branch and upstream source using OpenFeature CLI'
author: 'OpenFeature'

branding:
  icon: 'git-branch'
  color: 'blue'

inputs:
  against:
    description: 'URL/remote source OR local path for git comparison (optional for PR workflows)'
    required: false
  manifest:
    description: 'Path to local flag manifest file OR URL to remote manifest'
    required: false
    default: 'flags.json'
  base-branch:
    description: 'Base branch for git comparison (auto-detected in PRs)'
    required: false
  auth-token:
    description: 'Authentication token for accessing the against source (optional)'
    required: false
  manifest-auth-token:
    description: 'Authentication token for accessing the manifest source (optional)'
    required: false
  cli-version:
    description: 'OpenFeature CLI version to use'
    required: false
    default: 'latest'
  against-manifest-path:
    description: 'Path where the manifest from the against source will be saved'
    required: false
    default: 'against-flags.json'
  strict:
    description: 'Strict mode - fail the action if differences are found'
    required: false
    default: 'false'
  post-pr-comment:
    description: 'Post a comment on the PR when differences are detected'
    required: false
    default: 'true'

outputs:
  has-differences:
    description: 'Whether differences were found between manifests'
    value: ${{ steps.compare.outputs.has-differences }}
  comparison-result:
    description: 'Raw comparison output from OpenFeature CLI'
    value: ${{ steps.compare.outputs.comparison-result }}
  against-manifest-path:
    description: 'Path to the downloaded manifest from the against source'
    value: ${{ steps.compare.outputs.against-manifest-path }}
  local-manifest-path:
    description: 'Path to the local manifest file (original path or downloaded from URL)'
    value: ${{ steps.compare.outputs.local-manifest-path }}
  summary:
    description: 'Human-readable summary of changes'
    value: ${{ steps.compare.outputs.summary }}

runs:
  using: 'composite'
  steps:
    - name: Setup and Install CLI
      shell: bash
      run: |
        echo "::group::Installing OpenFeature CLI"

        # Define reusable functions
        is_url() {
          [[ "$1" =~ :// ]] || [[ "$1" =~ ^[^/]+:[^/] ]]
        }

        get_target_branch() {
          if [ -n "${{ github.base_ref }}" ]; then
            echo "${{ github.base_ref }}"
          elif [ -n "${{ inputs.base-branch }}" ]; then
            echo "${{ inputs.base-branch }}"
          else
            echo "main"
          fi
        }

        # Logging functions for better readability
        log_info() { echo "‚ÑπÔ∏è  $*"; }
        log_success() { echo "::notice::‚úÖ $*"; }
        log_error() { echo "::error::‚ùå $*"; }
        log_group() { echo "::group::üì¶ $*"; }
        log_endgroup() { echo "::endgroup::"; }
        log_debug() {
          # Only output if GitHub Actions debug mode is enabled (RUNNER_DEBUG=1)
          if [ "${RUNNER_DEBUG:-0}" = "1" ]; then
            echo "üîç [DEBUG] $*"
          fi
        }

        pull_manifest() {
          local source_url="$1"
          local output_path="$2"
          local auth_token="$3"
          local description="$4"

          log_info "Pulling $description from: $source_url"

          # Build command as array to prevent command injection (no eval needed)
          local pull_cmd=(
            "$CLI_PATH"
            "pull"
            "--flag-source-url"
            "$source_url"
            "--manifest"
            "$output_path"
            "--no-prompt"
          )

          # Build display command for logging (with masked token)
          local display_cmd="$CLI_PATH pull --flag-source-url $source_url --manifest $output_path --no-prompt"

          if [ -n "$auth_token" ]; then
            log_info "Using authentication token for $description"
            pull_cmd+=("--auth-token" "$auth_token")
            display_cmd="$display_cmd --auth-token '***'"
          fi

          local output
          if ! output=$("${pull_cmd[@]}" 2>&1); then
            log_error "Failed to pull $description from $source_url"
            log_info "Attempted command: $display_cmd"
            log_info "CLI output:"
            echo "$output" | sed 's/^/    /'
            if [ -n "$auth_token" ]; then
              log_info "üí° Tip: Auth token was provided - verify it has correct permissions"
            else
              log_info "üí° Tip: No auth token provided - verify the URL is publicly accessible"
            fi
            return 1
          fi

          log_success "$description downloaded to $output_path"
        }

        fetch_git_manifest() {
          local target_branch="$1"
          local remote_path="$2"
          local output_path="$3"

          log_info "Fetching manifest from git branch $target_branch:$remote_path"

          # Verify the target branch exists
          if ! git rev-parse --verify "origin/$target_branch" >/dev/null 2>&1; then
            if ! git rev-parse --verify "$target_branch" >/dev/null 2>&1; then
              log_error "Git branch '$target_branch' not found in repository"
              log_info "Available branches:"
              git branch -a | head -n 10
              log_info ""
              log_info "üí° Tip: Ensure fetch-depth: 0 in actions/checkout to access all branches"
              return 1
            fi
          fi

          # Fetch manifest from target branch
          if ! git show "$target_branch:$remote_path" > "$output_path" 2>/dev/null; then
            if ! git show "origin/$target_branch:$remote_path" > "$output_path" 2>/dev/null; then
              log_error "Failed to fetch manifest '$remote_path' from branch '$target_branch'"
              log_info "Available files in branch root:"
              git ls-tree --name-only "$target_branch" 2>/dev/null | head -n 20 || git ls-tree --name-only "origin/$target_branch" 2>/dev/null | head -n 20
              log_info ""
              log_info "üí° Tip: Verify the manifest path is relative to repository root"
              return 1
            fi
          fi

          log_success "Successfully fetched manifest from branch $target_branch"
        }

        generate_config_table() {
          local manifest_path="$1"
          
          echo "| Parameter | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Local Manifest** | \`$manifest_path\` |" >> $GITHUB_STEP_SUMMARY
          
          # Determine and display the against source
          if is_url "${{ inputs.against }}"; then
            echo "| **Against Source** | \`${{ inputs.against }}\` |" >> $GITHUB_STEP_SUMMARY
          else
            # Git mode - show branch and path
            local target_branch=$(get_target_branch)
            local remote_path="${{ inputs.against }}"
            if [ -z "$remote_path" ]; then
              remote_path="${{ inputs.manifest }}"
            fi
            echo "| **Against Source** | Branch \`$target_branch\` at \`$remote_path\` |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "| **Strict Mode** | \`${{ inputs.strict }}\` |" >> $GITHUB_STEP_SUMMARY
        }

        # Export functions for use in subsequent steps
        declare -f is_url get_target_branch log_info log_success log_error log_group log_endgroup log_debug pull_manifest fetch_git_manifest generate_config_table > /tmp/action_functions.sh

        # Install CLI
        if [ "${{ inputs.cli-version }}" = "latest" ]; then
          VERSION=$(curl -s https://api.github.com/repos/open-feature/cli/releases/latest | grep -oP '"tag_name": "\K(.*)(?=")')
        else
          VERSION="${{ inputs.cli-version }}"
        fi

        echo "::notice::Installing OpenFeature CLI version: $VERSION"
        go install github.com/open-feature/cli/cmd/openfeature@${VERSION} 2>&1
        echo "$HOME/go/bin" >> $GITHUB_PATH

        # Set CLI path for reuse
        CLI_PATH="$HOME/go/bin/openfeature"
        echo "CLI_PATH=$CLI_PATH" >> $GITHUB_ENV

        # Verify installation
        $CLI_PATH version
        echo "::endgroup::"

    - name: Resolve Manifests
      shell: bash
      run: |
        # Source our functions
        source /tmp/action_functions.sh

        log_group "Resolving local manifest: ${{ inputs.manifest }}"

        # Resolve local manifest
        if is_url "${{ inputs.manifest }}"; then
          log_info "Detected remote URL, downloading..."
          log_debug "URL: ${{ inputs.manifest }}"
          log_debug "Auth token provided: ${{ inputs.manifest-auth-token != '' && 'yes' || 'no' }}"
          LOCAL_MANIFEST_PATH="local-manifest.json"
          pull_manifest "${{ inputs.manifest }}" "$LOCAL_MANIFEST_PATH" "${{ inputs.manifest-auth-token }}" "manifest" || exit 1
        else
          log_info "Using local file..."
          log_debug "File path: ${{ inputs.manifest }}"
          LOCAL_MANIFEST_PATH="${{ inputs.manifest }}"
          if [ ! -f "$LOCAL_MANIFEST_PATH" ]; then
            log_error "Manifest file not found: ${{ inputs.manifest }}"
            log_info "Current working directory: $(pwd)"
            log_info "Files in current directory:"
            ls -la | head -n 20
            log_info ""
            log_info "üí° Tip: Verify the manifest path is relative to repository root"
            exit 1
          fi
          log_success "Found manifest at $LOCAL_MANIFEST_PATH"
        fi

        log_endgroup

        log_group "Resolving comparison target: ${{ inputs.against }}"

        # Resolve against manifest
        if is_url "${{ inputs.against }}"; then
          log_info "Detected remote URL, downloading..."
          log_debug "URL: ${{ inputs.against }}"
          log_debug "Auth token provided: ${{ inputs.auth-token != '' && 'yes' || 'no' }}"
          pull_manifest "${{ inputs.against }}" "${{ inputs.against-manifest-path }}" "${{ inputs.auth-token }}" "against manifest" || exit 1
          REMOTE_COMPARISON="true"
        elif [ -n "${{ inputs.against }}" ] && [ -f "${{ inputs.against }}" ]; then
          # Against is a local file - copy it to the expected location
          log_info "Using local file..."
          log_debug "File path: ${{ inputs.against }}"
          cp "${{ inputs.against }}" "${{ inputs.against-manifest-path }}"
          log_success "Copied local against file to ${{ inputs.against-manifest-path }}"
          REMOTE_COMPARISON="false"
        elif [ -n "${{ inputs.against }}" ]; then
          # Against is specified but not a URL or existing local file - treat as git path
          log_info "Git mode: comparing different paths"
          target_branch=$(get_target_branch)
          remote_path="${{ inputs.against }}"
          log_debug "Branch: $target_branch, Path: $remote_path"
          log_info "Base: $remote_path on $target_branch, Local: ${{ inputs.manifest }}"
          fetch_git_manifest "$target_branch" "$remote_path" "${{ inputs.against-manifest-path }}" || exit 1
          REMOTE_COMPARISON="false"
        else
          # No against specified - use same manifest path from target branch
          log_info "Git mode: comparing same path across branches"
          target_branch=$(get_target_branch)
          remote_path="${{ inputs.manifest }}"
          log_debug "Branch: $target_branch, Path: $remote_path"
          log_info "Comparing $remote_path between current branch and $target_branch"
          fetch_git_manifest "$target_branch" "$remote_path" "${{ inputs.against-manifest-path }}" || exit 1
          REMOTE_COMPARISON="false"
        fi

        # Verify against manifest exists
        if [ ! -f "${{ inputs.against-manifest-path }}" ]; then
          log_error "Against manifest file not found at ${{ inputs.against-manifest-path }}"
          exit 1
        fi

        # Log comparison mode
        if [ "$REMOTE_COMPARISON" = "true" ]; then
          log_info "üåê Using remote comparison perspective (manifest = desired state)"
        else
          log_info "üìä Using git comparison perspective (showing branch changes)"
        fi

        # Export paths and flags for comparison step
        echo "LOCAL_MANIFEST_PATH=$LOCAL_MANIFEST_PATH" >> $GITHUB_ENV
        echo "REMOTE_COMPARISON=$REMOTE_COMPARISON" >> $GITHUB_ENV
        LOCAL_SIZE=$(wc -c < "$LOCAL_MANIFEST_PATH")
        AGAINST_SIZE=$(wc -c < "${{ inputs.against-manifest-path }}")
        log_success "Manifests resolved (local: ${LOCAL_SIZE} bytes, against: ${AGAINST_SIZE} bytes)"

        log_debug "Local manifest path: $LOCAL_MANIFEST_PATH"
        log_debug "Against manifest path: ${{ inputs.against-manifest-path }}"
        log_debug "Comparison mode: $([ "$REMOTE_COMPARISON" = "true" ] && echo "remote" || echo "git")"

        log_endgroup

    - name: Compare manifests
      id: compare
      shell: bash
      run: |
        # Source our functions
        source /tmp/action_functions.sh

        # ============================================================================
        # COMPARISON MODE: Determine perspective and parameters
        # ============================================================================
        # Git mode: Show "what changed in this branch"
        #   - additions = flags added in PR
        #   - removals = flags removed in PR
        #
        # Remote mode: Show "what will change in remote when pushed" (manifest = desired state)
        #   - We swap CLI parameters so remote is the reference
        #   - Then use swapped section names so output shows push impact
        # ============================================================================

        if [ "$REMOTE_COMPARISON" = "true" ]; then
          log_group "Running comparison in remote mode"

          # Remote comparison: swap parameters to compare remote vs local
          # This makes remote the "old" state and local the "new" desired state
          MANIFEST_PARAM="${{ inputs.against-manifest-path }}"
          # Swap parameters: AGAINST_PARAM is set to local manifest so comparison shows what will change in remote.
          AGAINST_PARAM="$LOCAL_MANIFEST_PATH"

          # Section mappings (for parsing output with correct perspective)
          # CLI's "additions" (in remote, not in local) = will be REMOVED from remote
          # CLI's "removals" (in local, not in remote) = will be ADDED to remote
          ADD_SECTION="removals"
          REMOVE_SECTION="additions"

          # User-facing descriptions
          ADD_DESC="Flags that will be added to remote"
          REMOVE_DESC="Flags that will be removed from remote"
          MODIFY_DESC="Flags that will be modified in remote"

          log_info "Perspective: What will change in remote when pushed"
          log_info "Command: compare --manifest <remote> --against <local>"
        else
          log_group "Running comparison in git mode"

          # Git comparison: normal parameter order
          MANIFEST_PARAM="$LOCAL_MANIFEST_PATH"
          AGAINST_PARAM="${{ inputs.against-manifest-path }}"

          # Normal section mappings
          ADD_SECTION="additions"
          REMOVE_SECTION="removals"

          # User-facing descriptions
          ADD_DESC="Flags added in this branch"
          REMOVE_DESC="Flags removed in this branch"
          MODIFY_DESC="Flags modified in this branch"

          log_info "Perspective: What changed in current branch"
          log_info "Command: compare --manifest <local> --against <base>"
        fi

        # Create output directory
        mkdir -p comparison-output

        # Debug: Show manifest contents
        if [ "${RUNNER_DEBUG:-0}" = "1" ]; then
          log_debug "=== MANIFEST CONTENTS ==="
          log_debug "Local manifest ($LOCAL_MANIFEST_PATH):"
          cat "$LOCAL_MANIFEST_PATH" | head -n 50
          log_debug ""
          log_debug "Against manifest (${{ inputs.against-manifest-path }}):"
          cat "${{ inputs.against-manifest-path }}" | head -n 50
          log_debug ""
          log_debug "=== END MANIFEST CONTENTS ==="
        fi

        # Run comparison
        log_info "Executing OpenFeature CLI compare..."

        # Debug: Show exact command
        log_debug "Exact command being executed:"
        log_debug "$CLI_PATH compare --manifest \"$MANIFEST_PARAM\" --against \"$AGAINST_PARAM\" --output yaml"

        set +e
        COMPARE_OUTPUT=$($CLI_PATH compare --manifest "$MANIFEST_PARAM" --against "$AGAINST_PARAM" --output yaml 2>&1)
        COMPARE_EXIT_CODE=$?
        set -e

        log_debug "CLI exit code: $COMPARE_EXIT_CODE"

        # Save raw output
        echo "$COMPARE_OUTPUT" > comparison-output/raw-output.txt

        # Debug: Show raw CLI output
        if [ "${RUNNER_DEBUG:-0}" = "1" ]; then
          log_debug "=== RAW CLI OUTPUT ==="
          echo "$COMPARE_OUTPUT" | head -n 100
          log_debug "=== END RAW CLI OUTPUT ==="
        fi

        # Determine differences
        HAS_DIFFERENCES="false"
        if echo "$COMPARE_OUTPUT" | grep -q "No differences found between the manifests"; then
          HAS_DIFFERENCES="false"
          log_success "No differences found"
        elif [ -n "$COMPARE_OUTPUT" ]; then
          HAS_DIFFERENCES="true"
          log_info "Differences detected"
        fi

        # Export section mappings for next step
        echo "ADD_SECTION=$ADD_SECTION" >> $GITHUB_ENV
        echo "REMOVE_SECTION=$REMOVE_SECTION" >> $GITHUB_ENV
        echo "ADD_DESC=$ADD_DESC" >> $GITHUB_ENV
        echo "REMOVE_DESC=$REMOVE_DESC" >> $GITHUB_ENV
        echo "MODIFY_DESC=$MODIFY_DESC" >> $GITHUB_ENV

        # Set outputs
        echo "has-differences=$HAS_DIFFERENCES" >> $GITHUB_OUTPUT
        echo "comparison-result<<EOF" >> $GITHUB_OUTPUT
        echo "$COMPARE_OUTPUT" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        echo "against-manifest-path=${{ inputs.against-manifest-path }}" >> $GITHUB_OUTPUT
        echo "local-manifest-path=$LOCAL_MANIFEST_PATH" >> $GITHUB_OUTPUT

        # Generate summary
        if [ "$HAS_DIFFERENCES" = "true" ]; then
          SUMMARY="üîç Flag manifest differences detected"
          echo "::warning::Differences found between manifests"
        else
          SUMMARY="‚úÖ No differences found between manifests"
        fi

        echo "summary<<EOF" >> $GITHUB_OUTPUT
        echo "$SUMMARY" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

        log_endgroup

    - name: Generate Summary
      shell: bash
      run: |
        # Source our functions
        source /tmp/action_functions.sh

        log_group "Generating summary"

        # Determine comparison type
        if is_url "${{ inputs.against }}"; then
          COMPARISON_TITLE="## üåê Remote Push Preview"
          COMPARISON_SUBTITLE="Showing what will change in the remote flag service when changes are pushed"
          IS_REMOTE_URL="true"
        else
          target_branch=$(get_target_branch)
          COMPARISON_TITLE="## üîÄ Git Branch Comparison"
          COMPARISON_SUBTITLE="Comparing against $target_branch branch"
          IS_REMOTE_URL="false"
        fi

        # Header
        echo "$COMPARISON_TITLE" >> $GITHUB_STEP_SUMMARY
        echo "*$COMPARISON_SUBTITLE*" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        HAS_DIFFERENCES="${{ steps.compare.outputs.has-differences }}"

        if [ "$HAS_DIFFERENCES" = "true" ]; then
          # Status banner
          echo "> [!WARNING]" >> $GITHUB_STEP_SUMMARY
          if [ "$IS_REMOTE_URL" = "true" ]; then
            echo "> **Changes Will Be Applied** - The following changes will be made to the remote flag service when pushed" >> $GITHUB_STEP_SUMMARY
            echo "> **Remote Source:** \`${{ inputs.against }}\`" >> $GITHUB_STEP_SUMMARY
          else
            target_branch=$(get_target_branch)
            echo "> **Changes Detected** - This branch modifies the flag manifest compared to $target_branch" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Parse YAML and generate change summary
          if [ -f "comparison-output/raw-output.txt" ]; then
            RAW_YAML=$(cat comparison-output/raw-output.txt)

            # Count changes using yq (robust YAML parsing)
            # Use section mappings from previous step (already swapped for remote mode)
            ADD_COUNT=$(echo "$RAW_YAML" | yq e ".$ADD_SECTION | length // 0" -)
            REMOVE_COUNT=$(echo "$RAW_YAML" | yq e ".$REMOVE_SECTION | length // 0" -)
            MODIFY_COUNT=$(echo "$RAW_YAML" | yq e '.modifications | length // 0' -)

            log_info "Parsed changes: $ADD_COUNT additions, $REMOVE_COUNT removals, $MODIFY_COUNT modifications"

            # Export for PR comments
            echo "ADD_COUNT=$ADD_COUNT" >> $GITHUB_ENV
            echo "REMOVE_COUNT=$REMOVE_COUNT" >> $GITHUB_ENV
            echo "MODIFY_COUNT=$MODIFY_COUNT" >> $GITHUB_ENV
            echo "TOTAL_CHANGES=$((ADD_COUNT + REMOVE_COUNT + MODIFY_COUNT))" >> $GITHUB_ENV

            # Get mode-specific descriptions from environment (set in Compare step)
            # These already account for the correct perspective (git vs remote)

            # Set titles for sections
            if [ "$REMOTE_COMPARISON" = "true" ]; then
              ADD_TITLE="Flags That Will Be Added"
              REMOVE_TITLE="Flags That Will Be Removed"
              MODIFY_TITLE="Flags That Will Be Modified"
            else
              ADD_TITLE="Flags Added"
              REMOVE_TITLE="Flags Removed"
              MODIFY_TITLE="Flags Modified"
            fi

            # Summary table
            echo "## üìä Change Summary" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Change Type | Count | Description |" >> $GITHUB_STEP_SUMMARY
            echo "|-------------|-------|-------------|" >> $GITHUB_STEP_SUMMARY
            echo "| üü¢ **Additions** | **$ADD_COUNT** | $ADD_DESC |" >> $GITHUB_STEP_SUMMARY
            echo "| üî¥ **Removals** | **$REMOVE_COUNT** | $REMOVE_DESC |" >> $GITHUB_STEP_SUMMARY
            echo "| üü° **Modifications** | **$MODIFY_COUNT** | $MODIFY_DESC |" >> $GITHUB_STEP_SUMMARY
            echo "| **Total Changes** | **$((ADD_COUNT + REMOVE_COUNT + MODIFY_COUNT))** | Overall differences detected |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Build change details for PR comment using yq (robust parsing)
            CHANGE_DETAILS=""
            if [ $ADD_COUNT -gt 0 ]; then
              CHANGE_DETAILS="${CHANGE_DETAILS}### üü¢ $ADD_TITLE ($ADD_COUNT)\n"
              ADD_LIST=$(echo "$RAW_YAML" | yq e ".$ADD_SECTION[].path" - | sed 's|^flags\.||' | sed 's|^|üü¢ `|' | sed 's|$|`|')
              CHANGE_DETAILS="${CHANGE_DETAILS}${ADD_LIST}\n\n"
            fi
            if [ $REMOVE_COUNT -gt 0 ]; then
              CHANGE_DETAILS="${CHANGE_DETAILS}### üî¥ $REMOVE_TITLE ($REMOVE_COUNT)\n"
              REMOVE_LIST=$(echo "$RAW_YAML" | yq e ".$REMOVE_SECTION[].path" - | sed 's|^flags\.||' | sed 's|^|üî¥ `|' | sed 's|$|`|')
              CHANGE_DETAILS="${CHANGE_DETAILS}${REMOVE_LIST}\n\n"
            fi
            if [ $MODIFY_COUNT -gt 0 ]; then
              CHANGE_DETAILS="${CHANGE_DETAILS}### üü° $MODIFY_TITLE ($MODIFY_COUNT)\n"
              MODIFY_LIST=$(echo "$RAW_YAML" | yq e '.modifications[].path' - | sed 's|^flags\.||' | sed 's|^|üü° `|' | sed 's|$|`|')
              CHANGE_DETAILS="${CHANGE_DETAILS}${MODIFY_LIST}\n"
            fi
            
            # Export for PR comment
            echo "CHANGE_DETAILS<<EOF" >> $GITHUB_ENV
            echo -e "$CHANGE_DETAILS" >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
            
            # Configuration section
            echo "## Configuration" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "<details>" >> $GITHUB_STEP_SUMMARY
            echo "<summary>View configuration details</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            generate_config_table "$LOCAL_MANIFEST_PATH"
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Manifest diff
            echo "## üîÑ Manifest Diff" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "<details>" >> $GITHUB_STEP_SUMMARY
            echo "<summary>View unified diff between manifests</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```diff' >> $GITHUB_STEP_SUMMARY
            MANIFEST_DIFF=$(diff -u "$LOCAL_MANIFEST_PATH" "${{ inputs.against-manifest-path }}" | tail -n +3 || true)
            echo "$MANIFEST_DIFF" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Export diff for PR comment
            echo "MANIFEST_DIFF<<EOF" >> $GITHUB_ENV
            echo "$MANIFEST_DIFF" >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
            
            # Raw output
            echo "## üìÑ Raw Output" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "<details>" >> $GITHUB_STEP_SUMMARY
            echo "<summary>Click to expand raw YAML comparison output</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```yaml' >> $GITHUB_STEP_SUMMARY
            echo "$RAW_YAML" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
          fi
        else
          # Success case
          echo "> [!NOTE]" >> $GITHUB_STEP_SUMMARY
          if [ "$IS_REMOTE_URL" = "true" ]; then
            echo "> ‚úÖ **In Sync** - Your local manifest matches the remote flag service" >> $GITHUB_STEP_SUMMARY
            echo "> **Source:** \`${{ inputs.against }}\`" >> $GITHUB_STEP_SUMMARY
          else
            target_branch=$(get_target_branch)
            echo "> ‚úÖ **No Changes** - The flag manifest is identical to $target_branch branch" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üéâ Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$IS_REMOTE_URL" = "true" ]; then
            echo "Your local manifest matches the remote flag service. No changes will be applied when pushed. üöÄ" >> $GITHUB_STEP_SUMMARY
          else
            target_branch=$(get_target_branch)
            echo "No flag configuration changes in this branch compared to $target_branch. üöÄ" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Configuration section for success case
          echo "## Configuration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "<details>" >> $GITHUB_STEP_SUMMARY
          echo "<summary>View configuration details</summary>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          generate_config_table "$LOCAL_MANIFEST_PATH"
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "</details>" >> $GITHUB_STEP_SUMMARY
        fi

        # Footer
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        if [ "$IS_REMOTE_URL" = "true" ]; then
          echo "*üí° This preview shows what will change in the remote flag service when you push your local manifest*" >> $GITHUB_STEP_SUMMARY
        else
          echo "*üí° This comparison shows changes introduced in your branch compared to the target branch*" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "*Generated by [OpenFeature Manifest Compare Action](https://github.com/openfeature/action)*" >> $GITHUB_STEP_SUMMARY

        log_success "Summary generated successfully"
        log_endgroup

    - name: Post PR comment
      if: |
        github.event_name == 'pull_request' &&
        steps.compare.outputs.has-differences == 'true' &&
        inputs.post-pr-comment == 'true'
      uses: marocchino/sticky-pull-request-comment@v2
      with:
        header: openfeature-manifest-compare-${{ github.job }}
        message: |
          ## üöÄ OpenFeature Manifest Comparison (${{ github.job }})

          > [!WARNING]
          ${{ (contains(inputs.against, '://') || contains(inputs.against, ':')) &&
              format('> **Remote Push Preview** - The following changes will be applied to the remote flag service (`{0}`) when your manifest is pushed', inputs.against) ||
              format('> **Git Changes Detected** - Your feature flag manifest has changes compared to the {0} branch',
                     github.base_ref || inputs.base-branch || 'main') }}

          ### üìä Change Summary

          | Change Type | Count | Description |
          |-------------|-------|-------------|
          | üü¢ **Additions** | **${{ env.ADD_COUNT }}** | ${{ (contains(inputs.against, '://') || contains(inputs.against, ':')) && 'Flags that will be added to remote' || 'Flags added in this branch' }} |
          | üî¥ **Removals** | **${{ env.REMOVE_COUNT }}** | ${{ (contains(inputs.against, '://') || contains(inputs.against, ':')) && 'Flags that will be removed from remote' || 'Flags removed in this branch' }} |
          | üü° **Modifications** | **${{ env.MODIFY_COUNT }}** | ${{ (contains(inputs.against, '://') || contains(inputs.against, ':')) && 'Flags that will be modified in remote' || 'Flags modified in this branch' }} |
          | **Total** | **${{ env.TOTAL_CHANGES }}** | Total differences |

          <details>
          <summary>üìã View detailed changes</summary>

          ${{ env.CHANGE_DETAILS }}

          </details>

          <details>
          <summary>üîÑ View manifest diff</summary>

          ```diff
          ${{ env.MANIFEST_DIFF }}
          ```

          </details>

          ---
          ${{ (contains(inputs.against, '://') || contains(inputs.against, ':')) &&
              '*üí° This preview shows what will change in the remote flag service when you push your local manifest*' ||
              '*üìù This comparison shows changes introduced in this PR*' }}

          *This comment is automatically updated on each push*

    - name: Delete PR comment if no differences
      if: |
        github.event_name == 'pull_request' &&
        steps.compare.outputs.has-differences == 'false' &&
        inputs.post-pr-comment == 'true'
      uses: marocchino/sticky-pull-request-comment@v2
      with:
        header: openfeature-manifest-compare-${{ github.job }}
        delete: true

    - name: Handle failure condition
      shell: bash
      run: |
        HAS_DIFFERENCES="${{ steps.compare.outputs.has-differences }}"
        STRICT_MODE="${{ inputs.strict }}"

        if [ "$HAS_DIFFERENCES" = "true" ] && [ "$STRICT_MODE" = "true" ]; then
          echo "::error::Manifest differences detected in strict mode"
          exit 1
        fi
