name: Test OpenFeature Manifest Compare Action

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:
  merge_group:

permissions:
  contents: read
  pull-requests: write # Required for posting PR comments

jobs:
  test-action:
    runs-on: ubuntu-latest
    name: Test manifest comparison

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create sample local manifest
        run: |
          cat > openfeature.json << EOF
          {
            "flags": {
              "enableFeatureA": {
                "flagType": "boolean",
                "defaultValue": true,
                "description": "Controls whether Feature A is enabled - modified locally."
              },
              "localOnlyFlag": {
                "flagType": "string",
                "defaultValue": "Local only value",
                "description": "A flag that only exists locally."
              }
            }
          }
          EOF

      - name: Test action with sample upstream
        uses: ./
        id: compare-manifests
        with:
          against: "https://raw.githubusercontent.com/open-feature/cli/refs/heads/main/sample/sample_manifest.json"
          manifest: "openfeature.json"
          strict: false
          post-pr-comment: false

      - name: Display comparison results
        run: |
          echo "::notice::Has differences: ${{ steps.compare-manifests.outputs.has-differences }}"
          echo "::notice::Summary: ${{ steps.compare-manifests.outputs.summary }}"

      - name: Test with strict mode enabled
        uses: ./
        id: compare-with-fail
        continue-on-error: true
        with:
          against: "https://raw.githubusercontent.com/open-feature/cli/refs/heads/main/sample/sample_manifest.json"
          manifest: "openfeature.json"
          strict: true
          post-pr-comment: false
          against-manifest-path: "against-test.json"

      - name: Test error handling - missing local file
        uses: ./
        id: test-missing-local
        continue-on-error: true
        with:
          against: "https://raw.githubusercontent.com/open-feature/cli/refs/heads/main/sample/sample_manifest.json"
          manifest: "nonexistent.yml"
          post-pr-comment: false

      - name: Verify error handling worked
        run: |
          if [ "${{ steps.test-missing-local.outcome }}" != "failure" ]; then
            echo "::error::Expected test-missing-local to fail but it didn't"
            exit 1
          fi
          echo "::notice::Error handling test passed - action correctly failed with missing local file"

      - name: Test error handling - invalid remote against URL
        uses: ./
        id: test-invalid-against
        continue-on-error: true
        with:
          against: "https://httpbin.org/status/404"
          manifest: "flags.json"
          post-pr-comment: false

      - name: Verify invalid against URL error handling
        run: |
          if [ "${{ steps.test-invalid-against.outcome }}" != "failure" ]; then
            echo "::error::Expected test-invalid-against to fail but it didn't"
            exit 1
          fi
          echo "::notice::Error handling test passed - action correctly failed with invalid against URL"

      - name: Test error handling - authentication required (401)
        uses: ./
        id: test-auth-required
        continue-on-error: true
        with:
          against: "https://httpbin.org/status/401"
          manifest: "flags.json"
          post-pr-comment: false

      - name: Verify authentication error handling
        run: |
          if [ "${{ steps.test-auth-required.outcome }}" != "failure" ]; then
            echo "::error::Expected test-auth-required to fail but it didn't"
            exit 1
          fi
          echo "::notice::Error handling test passed - action correctly failed with 401 authentication error"

      - name: Test error handling - invalid remote manifest URL
        uses: ./
        id: test-invalid-manifest
        continue-on-error: true
        with:
          manifest: "https://httpbin.org/status/500"
          against: "flags.json"
          post-pr-comment: false

      - name: Verify invalid manifest URL error handling
        run: |
          if [ "${{ steps.test-invalid-manifest.outcome }}" != "failure" ]; then
            echo "::error::Expected test-invalid-manifest to fail but it didn't"
            exit 1
          fi
          echo "::notice::Error handling test passed - action correctly failed with invalid manifest URL"

  test-manifest-differences:
    runs-on: ubuntu-latest
    name: Test various manifest difference scenarios

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Test scenario - Flags added locally
        run: |
          echo "::notice::Testing scenario where local has additional flags"

          # Create local manifest with extra flags
          cat > local-added.json << EOF
          {
            "flags": {
              "existingFlag": {
                "flagType": "boolean",
                "defaultValue": true,
                "description": "Flag that exists in both"
              },
              "newLocalFlag": {
                "flagType": "string",
                "defaultValue": "local-only",
                "description": "Flag added locally, not in remote"
              },
              "anotherNewFlag": {
                "flagType": "number",
                "defaultValue": 42,
                "description": "Another flag only in local"
              }
            }
          }
          EOF

      - name: Compare - local has additional flags
        uses: ./
        id: test-added
        with:
          against: "https://raw.githubusercontent.com/open-feature/cli/refs/heads/main/sample/sample_manifest.json"
          manifest: "local-added.json"
          post-pr-comment: false

      - name: Display results for added flags
        run: |
          echo "Has differences: ${{ steps.test-added.outputs.has-differences }}"
          echo "Comparison output:"
          echo "${{ steps.test-added.outputs.comparison-result }}"

      - name: Test scenario - Flags removed locally
        run: |
          echo "::notice::Testing scenario where local is missing flags that exist in remote"

          # Create minimal local manifest (missing many remote flags)
          cat > local-removed.json << EOF
          {
            "flags": {
              "exampleBool": {
                "flagType": "boolean",
                "defaultValue": false,
                "description": "One of the few flags kept locally"
              }
            }
          }
          EOF

      - name: Compare - local missing flags
        uses: ./
        id: test-removed
        with:
          against: "https://raw.githubusercontent.com/open-feature/cli/refs/heads/main/sample/sample_manifest.json"
          manifest: "local-removed.json"
          post-pr-comment: false

      - name: Display results for removed flags
        run: |
          echo "Has differences: ${{ steps.test-removed.outputs.has-differences }}"
          echo "Summary: ${{ steps.test-removed.outputs.summary }}"

      - name: Test scenario - Modified flag values
        run: |
          echo "::notice::Testing scenario where flags exist in both but with different values"

          # Create local manifest with modified values
          cat > local-modified.json << EOF
          {
            "flags": {
              "exampleBool": {
                "flagType": "boolean",
                "defaultValue": true,
                "description": "Modified: was false, now true"
              },
              "exampleStr": {
                "flagType": "string",
                "defaultValue": "production-value",
                "description": "Modified: different default value"
              },
              "exampleNum": {
                "flagType": "number",
                "defaultValue": 999,
                "description": "Modified: was 10, now 999"
              }
            }
          }
          EOF

      - name: Compare - modified flag values
        uses: ./
        id: test-modified
        with:
          against: "https://raw.githubusercontent.com/open-feature/cli/refs/heads/main/sample/sample_manifest.json"
          manifest: "local-modified.json"
          post-pr-comment: false

      - name: Display results for modified flags
        run: |
          echo "Has differences: ${{ steps.test-modified.outputs.has-differences }}"
          echo "Comparison output:"
          echo "${{ steps.test-modified.outputs.comparison-result }}"

      - name: Test scenario - Identical manifests
        run: |
          echo "::notice::Testing scenario where manifests are identical"

          # Download the remote manifest to use as local
          curl -s https://raw.githubusercontent.com/open-feature/cli/refs/heads/main/sample/sample_manifest.json > identical.json

      - name: Compare - identical manifests
        uses: ./
        id: test-identical
        with:
          against: "https://raw.githubusercontent.com/open-feature/cli/refs/heads/main/sample/sample_manifest.json"
          manifest: "identical.json"
          post-pr-comment: false

      - name: Display results for identical manifests
        run: |
          echo "Has differences: ${{ steps.test-identical.outputs.has-differences }}"
          echo "Summary: ${{ steps.test-identical.outputs.summary }}"
          if [ "${{ steps.test-identical.outputs.has-differences }}" = "true" ]; then
            echo "::error::Expected no differences for identical manifests!"
            exit 1
          fi
          echo "✅ Correctly identified identical manifests"

      - name: Test scenario - Complex mixed changes
        run: |
          echo "::notice::Testing scenario with added, removed, and modified flags"

          cat > local-mixed.json << EOF
          {
            "flags": {
              "exampleBool": {
                "flagType": "boolean",
                "defaultValue": true,
                "description": "Modified from original"
              },
              "brandNewFeature": {
                "flagType": "boolean", 
                "defaultValue": false,
                "description": "Added: New feature flag"
              },
              "anotherNewFlag": {
                "flagType": "string",
                "defaultValue": "innovation",
                "description": "Added: Another new flag"
              }
            }
          }
          EOF
          echo "Note: This manifest has modified exampleBool, added new flags, and removed exampleStr and exampleNum"

      - name: Compare - mixed changes
        uses: ./
        id: test-mixed
        with:
          against: "https://raw.githubusercontent.com/open-feature/cli/refs/heads/main/sample/sample_manifest.json"
          manifest: "local-mixed.json"
          post-pr-comment: false

      - name: Display results for mixed changes
        run: |
          echo "Has differences: ${{ steps.test-mixed.outputs.has-differences }}"
          echo "YAML output:"
          echo "${{ steps.test-mixed.outputs.comparison-result }}"

  test-cli-versions:
    runs-on: ubuntu-latest
    name: Test different CLI versions
    strategy:
      matrix:
        cli-version: ["latest", "v0.3.12", "v0.3.6"]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create test manifest
        run: |
          cat > version-test.json << EOF
          {
            "flags": {
              "versionTest": {
                "flagType": "boolean",
                "defaultValue": true,
                "description": "A flag for testing CLI versions."
              }
            }
          }
          EOF

      - name: Test with CLI version ${{ matrix.cli-version }}
        uses: ./
        with:
          against: "https://raw.githubusercontent.com/open-feature/cli/refs/heads/main/sample/sample_manifest.json"
          manifest: "version-test.json"
          cli-version: ${{ matrix.cli-version }}
          post-pr-comment: false

  test-git-mode:
    runs-on: ubuntu-latest
    name: Test Git branch comparison mode

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch full history for branch comparison

      - name: Create sample manifest on current branch
        run: |
          cat > flags.json << EOF
          {
            "flags": {
              "gitModeTest": {
                "flagType": "boolean",
                "defaultValue": true,
                "description": "Test flag for git mode"
              },
              "newFeatureFlag": {
                "flagType": "string",
                "defaultValue": "feature-branch-value",
                "description": "Flag added on feature branch"
              }
            }
          }
          EOF

      - name: Test git mode with explicit base branch (should use main)
        uses: ./
        id: git-mode-explicit
        with:
          base-branch: main
          manifest: flags.json
          strict: false
          post-pr-comment: false
        continue-on-error: true

      - name: Display git mode results
        run: |
          echo "::notice::Git mode test completed"
          echo "Has differences: ${{ steps.git-mode-explicit.outputs.has-differences }}"
          echo "Summary: ${{ steps.git-mode-explicit.outputs.summary }}"

      - name: Test minimal git mode (no against specified)
        uses: ./
        id: git-mode-minimal
        with:
          manifest: flags.json
          strict: false
          post-pr-comment: false
        continue-on-error: true

      - name: Test git mode with different path mapping
        run: |
          # Create a manifest in a subdirectory
          mkdir -p config
          cat > config/feature-flags.json << EOF
          {
            "flags": {
              "pathMappingTest": {
                "flagType": "number",
                "defaultValue": 123,
                "description": "Test different path mapping"
              }
            }
          }
          EOF

      - name: Test git mode with path mapping
        uses: ./
        id: git-mode-path-mapping
        with:
          manifest: config/feature-flags.json
          against: flags.json # Compare different paths
          base-branch: main
          strict: false
          post-pr-comment: false
        continue-on-error: true

  test-protocol-detection:
    runs-on: ubuntu-latest
    name: Test various URL protocol detection

    strategy:
      matrix:
        protocol:
          - url: "https://raw.githubusercontent.com/open-feature/cli/refs/heads/main/sample/sample_manifest.json"
            description: "HTTPS URL"
          - url: "http://httpbin.org/json"
            description: "HTTP URL"
          - url: "file:///etc/hosts"
            description: "File protocol"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create test manifest
        run: |
          cat > protocol-test.json << EOF
          {
            "flags": {
              "protocolTest": {
                "flagType": "string", 
                "defaultValue": "test-value",
                "description": "Testing protocol detection for ${{ matrix.protocol.description }}"
              }
            }
          }
          EOF

      - name: Test ${{ matrix.protocol.description }}
        uses: ./
        continue-on-error: true
        with:
          against: ${{ matrix.protocol.url }}
          manifest: protocol-test.json
          strict: false
          post-pr-comment: false

  test-remote-to-remote:
    runs-on: ubuntu-latest
    name: Test remote-to-remote manifest comparison

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Test remote manifest against remote against
        uses: ./
        id: remote-to-remote
        with:
          manifest: "https://raw.githubusercontent.com/open-feature/cli/refs/heads/main/sample/sample_manifest.json"
          against: "https://raw.githubusercontent.com/open-feature/cli/refs/heads/main/sample/sample_manifest.json"
          post-pr-comment: false

      - name: Verify identical remote manifests
        run: |
          echo "Has differences: ${{ steps.remote-to-remote.outputs.has-differences }}"
          echo "Local manifest path: ${{ steps.remote-to-remote.outputs.local-manifest-path }}"
          echo "Against manifest path: ${{ steps.remote-to-remote.outputs.against-manifest-path }}"

          if [ "${{ steps.remote-to-remote.outputs.has-differences }}" = "true" ]; then
            echo "::error::Expected no differences for identical remote manifests!"
            exit 1
          fi
          echo "✅ Correctly identified identical remote manifests"

      - name: Test different remote manifests
        run: |
          # Create a different manifest to upload somewhere accessible
          cat > different-manifest.json << EOF
          {
            "flags": {
              "remoteTestFlag": {
                "flagType": "boolean",
                "defaultValue": true,
                "description": "A different flag for remote testing"
              }
            }
          }
          EOF

      - name: Test remote vs different remote (simulated)
        uses: ./
        id: different-remotes
        with:
          manifest: "https://raw.githubusercontent.com/open-feature/cli/refs/heads/main/sample/sample_manifest.json"
          against: different-manifest.json # Use local file as "against" to simulate different remote
          post-pr-comment: false

      - name: Verify different manifests detected
        run: |
          echo "Has differences: ${{ steps.different-remotes.outputs.has-differences }}"
          echo "Summary: ${{ steps.different-remotes.outputs.summary }}"

          if [ "${{ steps.different-remotes.outputs.has-differences }}" = "false" ]; then
            echo "::error::Expected differences between different manifests!"
            exit 1
          fi
          echo "✅ Correctly detected differences between remote and local manifests"

  test-output-consistency:
    runs-on: ubuntu-latest
    name: Verify raw output matches summary

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # For git mode test

      - name: Create local manifest with new flag (remote mode test)
        run: |
          cat > local-new-flag.json << EOF
          {
            "flags": {
              "exampleBool": {
                "flagType": "boolean",
                "defaultValue": true,
                "description": "Flag that exists in both"
              },
              "newFlagAddedLocally": {
                "flagType": "string",
                "defaultValue": "new-value",
                "description": "Flag added locally, will be added to remote when pushed"
              }
            }
          }
          EOF

      - name: Test remote mode
        id: remote-test
        uses: ./
        with:
          manifest: local-new-flag.json
          against: "https://raw.githubusercontent.com/open-feature/cli/refs/heads/main/sample/sample_manifest.json"
          post-pr-comment: false

      - name: Verify remote mode raw output matches summary
        run: |
          echo "=== Verifying Remote Mode Output Consistency ==="
          echo ""

          # Get raw YAML output
          RAW_YAML='${{ steps.remote-test.outputs.comparison-result }}'

          echo "Raw YAML output:"
          echo "$RAW_YAML"
          echo ""

          # Parse counts from raw YAML using yq
          ADD_COUNT=$(echo "$RAW_YAML" | yq e '.additions | length // 0' -)
          REMOVE_COUNT=$(echo "$RAW_YAML" | yq e '.removals | length // 0' -)
          MODIFY_COUNT=$(echo "$RAW_YAML" | yq e '.modifications | length // 0' -)

          echo "Counts from raw YAML:"
          echo "  Additions: $ADD_COUNT"
          echo "  Removals: $REMOVE_COUNT"
          echo "  Modifications: $MODIFY_COUNT"
          echo ""

          # Verify expectations for remote mode
          # Local manifest has 1 new flag (newFlagAddedLocally)
          # This should appear in "additions" section
          # (what will be ADDED to remote when pushed)

          if [ "$ADD_COUNT" -eq 0 ]; then
            echo "::error::Expected at least 1 addition in raw YAML (new flag in local)"
            echo "::error::Raw YAML should show what will be ADDED to remote"
            exit 1
          fi

          echo "✅ Raw YAML has correct structure for remote mode"
          echo "✅ Additions section correctly shows flags that will be added to remote"
          echo ""

          # Verify summary perspective
          SUMMARY='${{ steps.remote-test.outputs.summary }}'
          echo "Summary: $SUMMARY"
          echo ""

          # Summary should indicate remote perspective
          if ! echo "$SUMMARY" | grep -qi "differences"; then
            echo "::error::Summary doesn't indicate differences were detected!"
            exit 1
          fi

          echo "✅ Remote mode perspective is correct in summary"

      - name: Create local manifest for git mode test
        run: |
          cat > flags.json << EOF
          {
            "flags": {
              "gitModeFlag": {
                "flagType": "boolean",
                "defaultValue": true,
                "description": "Test flag for git mode"
              }
            }
          }
          EOF

      - name: Test git mode
        id: git-test
        uses: ./
        with:
          manifest: flags.json
          base-branch: main
          post-pr-comment: false
        continue-on-error: true

      - name: Verify git mode output
        run: |
          echo "=== Verifying Git Mode Output ==="
          echo ""

          SUMMARY='${{ steps.git-test.outputs.summary }}'
          echo "Summary: $SUMMARY"
          echo ""

          # Git mode should show "what changed in branch" perspective
          # If there are differences, verify the perspective is correct
          HAS_DIFF='${{ steps.git-test.outputs.has-differences }}'

          if [ "$HAS_DIFF" = "true" ]; then
            RAW_YAML='${{ steps.git-test.outputs.comparison-result }}'
            echo "Raw YAML output:"
            echo "$RAW_YAML"
            echo ""

            # Git mode shows what changed in this branch compared to base
            echo "✅ Git mode detected differences"
            echo "✅ Git mode shows what changed in branch"
          else
            echo "ℹ️  No differences detected in git mode (expected if flag exists in main)"
          fi

          echo "✅ Git mode test completed successfully"

      - name: Test output consistency summary
        run: |
          echo "=== Output Consistency Test Results ==="
          echo ""
          echo "✅ All tests passed!"
          echo "  - Remote mode output shows correct perspective"
          echo "  - Raw YAML output matches expected perspective"
          echo "  - Additions in raw YAML = flags that will be added to remote"
          echo "  - Git mode shows what changed in branch"
          echo ""
          echo "This confirms that the output consistency is correct for both modes"

  # Test generated client validation feature
  test-validation-feature:
    runs-on: ubuntu-latest
    name: Test Generated Client Validation

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Test validation with up-to-date files
        id: test-validation-pass
        uses: ./
        with:
          manifest: "flags.json"
          post-pr-comment: false
          validate-generators: '["react"]'
          validate-generators-output-dir: "test-gen-output"
          validate-generators-strict: false

      - name: Verify validation passed
        run: |
          echo "=== Testing Validation Feature ==="
          echo "Validation failed: ${{ steps.test-validation-pass.outputs.validation-failed }}"
          echo "Validation summary: ${{ steps.test-validation-pass.outputs.validation-summary }}"

      - name: Test validation detects out-of-sync files
        id: test-validation-detect
        uses: ./
        continue-on-error: true
        with:
          post-pr-comment: false
          manifest: "test-fixtures/test-manifest-modified.json"
          validate-generators: '["react"]'
          validate-generators-output-dir: "test-gen-output"
          validate-generators-strict: false

      - name: Verify validation detected changes
        run: |
          echo "Validation failed: ${{ steps.test-validation-detect.outputs.validation-failed }}"

          if [ "${{ steps.test-validation-detect.outputs.validation-failed }}" == "true" ]; then
            echo "✅ Validation correctly detected out-of-sync files"
          else
            echo "⚠️  Validation did not detect changes (may be expected if generation is idempotent)"
          fi

      - name: Test multiple generators
        id: test-multi-gen
        uses: ./
        with:
          manifest: "flags.json"
          post-pr-comment: false
          validate-generators: '["react", "go"]'
          validate-generators-output-dir: "test-gen-multi"
          validate-generators-strict: false

      - name: Verify multi-generator outputs
        run: |
          echo "=== Multi-Generator Test ==="
          echo "Validation summary: ${{ steps.test-multi-gen.outputs.validation-summary }}"
          echo "✅ Multiple generators validated successfully"

      - name: Test combined manifest comparison and validation
        uses: ./
        with:
          against: "https://raw.githubusercontent.com/open-feature/cli/refs/heads/main/sample/sample_manifest.json"
          manifest: "flags.json"
          strict: false
          post-pr-comment: false
          validate-generators: '["nodejs"]'
          validate-generators-output-dir: "test-combined"
          validate-generators-strict: false

      - name: Validation feature test summary
        run: |
          echo "=== Validation Feature Test Results ==="
          echo ""
          echo "✅ All validation tests passed!"
          echo "  - Up-to-date file validation works"
          echo "  - Out-of-sync detection works"
          echo "  - Multiple generators supported"
          echo "  - Combined comparison + validation works"
          echo "  - Outputs are set correctly"
          echo ""
          echo "Generated client validation feature is working correctly!"
