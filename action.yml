name: 'OpenFeature Manifest Compare'
description: 'Compare flag manifests between current branch and upstream source using OpenFeature CLI'
author: 'OpenFeature'

branding:
  icon: 'git-branch'
  color: 'blue'

inputs:
  against:
    description: 'URL/remote source OR local path for git comparison (optional for PR workflows)'
    required: false
  manifest:
    description: 'Path to local flag manifest file'
    required: false
    default: 'flags.json'
  base-branch:
    description: 'Base branch for git comparison (auto-detected in PRs)'
    required: false
  auth-token:
    description: 'Authentication token for accessing the flag source (optional)'
    required: false
  cli-version:
    description: 'OpenFeature CLI version to use'
    required: false
    default: 'latest'
  against-manifest-path:
    description: 'Path where the manifest from the against source will be saved'
    required: false
    default: 'against-flags.json'
  strict:
    description: 'Strict mode - fail the action if differences are found'
    required: false
    default: 'false'
  post-pr-comment:
    description: 'Post a comment on the PR when differences are detected'
    required: false
    default: 'true'

outputs:
  has-differences:
    description: 'Whether differences were found between manifests'
    value: ${{ steps.compare.outputs.has-differences }}
  comparison-result:
    description: 'Raw comparison output from OpenFeature CLI'
    value: ${{ steps.compare.outputs.comparison-result }}
  against-manifest-path:
    description: 'Path to the downloaded manifest from the against source'
    value: ${{ steps.compare.outputs.against-manifest-path }}
  summary:
    description: 'Human-readable summary of changes'
    value: ${{ steps.compare.outputs.summary }}

runs:
  using: 'composite'
  steps:
    - name: Install OpenFeature CLI
      shell: bash
      run: |
        echo "::group::Installing OpenFeature CLI"
        
        if [ "${{ inputs.cli-version }}" = "latest" ]; then
          VERSION=$(curl -s https://api.github.com/repos/open-feature/cli/releases/latest | grep -oP '"tag_name": "\K(.*)(?=")')
        else
          VERSION="${{ inputs.cli-version }}"
        fi
        
        echo "::notice::Installing OpenFeature CLI version: $VERSION"
        
        # Install OpenFeature CLI using Go (GitHub Actions runners have Go pre-installed)
        go install github.com/open-feature/cli/cmd/openfeature@${VERSION} 2>&1
        
        # Add Go bin to PATH
        echo "$HOME/go/bin" >> $GITHUB_PATH
        
        # Verify installation
        $HOME/go/bin/openfeature version
        echo "::endgroup::"

    - name: Pull against manifest
      shell: bash
      run: |
        echo "::group::Pulling against manifest"
        
        # Determine mode based on 'against' input
        if [[ "${{ inputs.against }}" =~ :// ]] || [[ "${{ inputs.against }}" =~ ^[^/]+:[^/] ]]; then
          MODE="url"
          echo "::notice::URL mode detected"
          echo "Source: ${{ inputs.against }}"
        else
          MODE="git"
          echo "::notice::Git mode detected"
          
          # Determine target branch
          if [ -n "${{ github.base_ref }}" ]; then
            # In PR context - use PR base branch
            TARGET_BRANCH="${{ github.base_ref }}"
            echo "::notice::Using PR base branch: $TARGET_BRANCH"
          elif [ -n "${{ inputs.base-branch }}" ]; then
            # Use explicitly provided base branch
            TARGET_BRANCH="${{ inputs.base-branch }}"
            echo "::notice::Using specified base branch: $TARGET_BRANCH"
          else
            # Default to 'main' branch
            TARGET_BRANCH="main"
            echo "::notice::Using default base branch: $TARGET_BRANCH"
          fi
          
          # Get manifest path (use 'against' if provided, otherwise use same as 'manifest')
          if [ -z "${{ inputs.against }}" ]; then
            REMOTE_PATH="${{ inputs.manifest }}"
            echo "::notice::Comparing same manifest path between branches: $REMOTE_PATH"
          else
            REMOTE_PATH="${{ inputs.against }}"
            echo "::notice::Comparing different paths - Base: $REMOTE_PATH, Local: ${{ inputs.manifest }}"
          fi
        fi
        
        if [ "$MODE" = "url" ]; then
          # URL mode - use OpenFeature CLI pull command
          PULL_CMD="$HOME/go/bin/openfeature pull --flag-source-url \"${{ inputs.against }}\" --manifest \"${{ inputs.against-manifest-path }}\" --no-prompt"
          
          # Add auth token if provided
          if [ -n "${{ inputs.auth-token }}" ]; then
            echo "::notice::Using authentication token for pulling manifest"
            PULL_CMD="$PULL_CMD --auth-token \"${{ inputs.auth-token }}\""
          fi
          
          # Use OpenFeature CLI pull command to fetch upstream manifest
          if ! eval $PULL_CMD; then
            echo "::error::Failed to pull manifest from ${{ inputs.against }}"
            exit 1
          fi
        else
          # Git mode - fetch manifest from target branch
          echo "::notice::Fetching manifest from git branch"
          
          # Verify the target branch exists
          if ! git rev-parse --verify "origin/$TARGET_BRANCH" >/dev/null 2>&1; then
            if ! git rev-parse --verify "$TARGET_BRANCH" >/dev/null 2>&1; then
              echo "::error::Target branch '$TARGET_BRANCH' not found in local or remote repository"
              exit 1
            fi
          fi
          
          # Fetch manifest from target branch
          if ! git show "$TARGET_BRANCH:$REMOTE_PATH" > "${{ inputs.against-manifest-path }}" 2>/dev/null; then
            # Try with origin/ prefix if direct branch doesn't work
            if ! git show "origin/$TARGET_BRANCH:$REMOTE_PATH" > "${{ inputs.against-manifest-path }}" 2>/dev/null; then
              echo "::error::Failed to fetch manifest '$REMOTE_PATH' from branch '$TARGET_BRANCH'"
              echo "::error::Make sure the manifest file exists in the target branch"
              exit 1
            fi
          fi
          
          echo "::notice::Successfully fetched manifest from branch $TARGET_BRANCH"
        fi
        
        # Verify against manifest exists and is readable
        if [ ! -f "${{ inputs.against-manifest-path }}" ]; then
          echo "::error::Against manifest file not found at ${{ inputs.against-manifest-path }}"
          exit 1
        fi
        
        MANIFEST_SIZE=$(wc -c < "${{ inputs.against-manifest-path }}")
        echo "::notice::Against manifest saved to ${{ inputs.against-manifest-path }} (${MANIFEST_SIZE} bytes)"
        echo "upstream-manifest-size=${MANIFEST_SIZE}" >> $GITHUB_OUTPUT
        echo "::endgroup::"

    - name: Compare manifests
      id: compare
      shell: bash
      run: |
        echo "::group::Comparing manifests"
        
        # Create output directory for comparison results
        mkdir -p comparison-output
        
        # Run OpenFeature CLI compare command with YAML output
        set +e  # Don't exit on non-zero return code
        COMPARE_OUTPUT=$($HOME/go/bin/openfeature compare --manifest "${{ inputs.manifest }}" --against "${{ inputs.against-manifest-path }}" --output yaml 2>&1)
        COMPARE_EXIT_CODE=$?
        set -e
        
        # Save raw comparison output
        echo "$COMPARE_OUTPUT" > comparison-output/raw-output.txt
        
        # Determine if there are differences
        HAS_DIFFERENCES="false"
        if echo "$COMPARE_OUTPUT" | grep -q "No differences found between the manifests"; then
          HAS_DIFFERENCES="false"
        elif [ -n "$COMPARE_OUTPUT" ]; then
          # If there's output and it's not the "no differences" message, differences exist
          HAS_DIFFERENCES="true"
        fi
        
        # Set outputs
        echo "has-differences=$HAS_DIFFERENCES" >> $GITHUB_OUTPUT
        echo "comparison-result<<EOF" >> $GITHUB_OUTPUT
        echo "$COMPARE_OUTPUT" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        echo "against-manifest-path=${{ inputs.against-manifest-path }}" >> $GITHUB_OUTPUT
        
        # Generate summary
        if [ "$HAS_DIFFERENCES" = "true" ]; then
          SUMMARY="üîç Flag manifest differences detected between local and against sources"
          echo "::warning::Differences found between local and against manifests"
        else
          SUMMARY="‚úÖ No differences found between local and against flag manifests"
          echo "::notice::Manifests are in sync"
        fi
        
        echo "summary<<EOF" >> $GITHUB_OUTPUT
        echo "$SUMMARY" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
        echo "::endgroup::"

    - name: Format output for GitHub Actions summary
      shell: bash
      run: |
        echo "::group::Generating summary"
        
        # Header with visual hierarchy
        echo "# üöÄ OpenFeature Manifest Comparison" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Use the step output directly instead of reading from GITHUB_OUTPUT
        HAS_DIFFERENCES="${{ steps.compare.outputs.has-differences }}"
        
        if [ "$HAS_DIFFERENCES" = "true" ]; then
          # Status banner with warning color
          echo "> [!WARNING]" >> $GITHUB_STEP_SUMMARY
          echo "> **Differences Detected** - Your local manifest differs from the against source" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Parse the YAML output to extract changes
          if [ -f "comparison-output/raw-output.txt" ]; then
            RAW_YAML=$(cat comparison-output/raw-output.txt)
            
            # Parse YAML to count changes
            # Count additions (flags that appear in against but not in local)
            ADD_COUNT=0
            if echo "$RAW_YAML" | grep -q "^additions:"; then
              # Count items under additions section (lines starting with "    - type:")
              ADD_COUNT=$(echo "$RAW_YAML" | sed -n '/^additions:/,/^[a-z]/p' | grep -c "^    - type:" || true)
            fi
            
            # Count removals (flags that appear in local but not in against)
            REMOVE_COUNT=0
            if echo "$RAW_YAML" | grep -q "^removals:"; then
              REMOVE_COUNT=$(echo "$RAW_YAML" | sed -n '/^removals:/,/^[a-z]/p' | grep -c "^    - type:" || true)
            fi
            
            # Count modifications (flags that exist in both but with different values)
            MODIFY_COUNT=0
            if echo "$RAW_YAML" | grep -q "^modifications:"; then
              MODIFY_COUNT=$(echo "$RAW_YAML" | sed -n '/^modifications:/,/^[a-z]/p' | grep -c "^    - type:" || true)
            fi
            
            # Export counts for PR comment
            echo "ADD_COUNT=$ADD_COUNT" >> $GITHUB_ENV
            echo "REMOVE_COUNT=$REMOVE_COUNT" >> $GITHUB_ENV
            echo "MODIFY_COUNT=$MODIFY_COUNT" >> $GITHUB_ENV
            echo "TOTAL_CHANGES=$((ADD_COUNT + REMOVE_COUNT + MODIFY_COUNT))" >> $GITHUB_ENV
            
            # Generate colorful summary table
            echo "## üìä Change Summary" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Change Type | Count | Description |" >> $GITHUB_STEP_SUMMARY
            echo "|-------------|-------|-------------|" >> $GITHUB_STEP_SUMMARY
            echo "| üü¢ **Additions** | **$ADD_COUNT** | New flags in against source |" >> $GITHUB_STEP_SUMMARY
            echo "| üî¥ **Removals** | **$REMOVE_COUNT** | Flags removed from local manifest |" >> $GITHUB_STEP_SUMMARY
            echo "| üü° **Modifications** | **$MODIFY_COUNT** | Flags with changed configurations |" >> $GITHUB_STEP_SUMMARY
            echo "| **Total Changes** | **$((ADD_COUNT + REMOVE_COUNT + MODIFY_COUNT))** | Overall differences detected |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Build change details for PR comment
            CHANGE_DETAILS=""
            
            # Detailed breakdown
            echo "## üîç Change Details" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Parse and display additions
            if [ $ADD_COUNT -gt 0 ]; then
              echo "> [!NOTE]" >> $GITHUB_STEP_SUMMARY
              echo "> ### üü¢ New Flags Added ($ADD_COUNT)" >> $GITHUB_STEP_SUMMARY
              echo "> The following flags are present in the **against source** but not in the **local manifest**:" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "<ul>" >> $GITHUB_STEP_SUMMARY
              echo "$RAW_YAML" | sed -n '/^additions:/,/^[a-z]/p' | grep "^      path:" | sed 's/^      path: flags\./<li>üü¢ <code>/' | sed 's/$/<\/code><\/li>/' >> $GITHUB_STEP_SUMMARY
              echo "</ul>" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              
              # Build for PR comment
              CHANGE_DETAILS="${CHANGE_DETAILS}### üü¢ New Flags Added ($ADD_COUNT)\n"
              ADD_LIST=$(echo "$RAW_YAML" | sed -n '/^additions:/,/^[a-z]/p' | grep "^      path:" | sed 's/^      path: flags\./- üü¢ `/' | sed 's/$/`/')
              CHANGE_DETAILS="${CHANGE_DETAILS}${ADD_LIST}\n\n"
            fi
            
            # Parse and display removals
            if [ $REMOVE_COUNT -gt 0 ]; then
              echo "> [!CAUTION]" >> $GITHUB_STEP_SUMMARY
              echo "> ### üî¥ Flags Removed ($REMOVE_COUNT)" >> $GITHUB_STEP_SUMMARY
              echo "> The following flags are present in the **local manifest** but not in the **against source**:" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "<ul>" >> $GITHUB_STEP_SUMMARY
              echo "$RAW_YAML" | sed -n '/^removals:/,/^[a-z]/p' | grep "^      path:" | sed 's/^      path: flags\./<li>üî¥ <code>/' | sed 's/$/<\/code><\/li>/' >> $GITHUB_STEP_SUMMARY
              echo "</ul>" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              
              # Build for PR comment
              CHANGE_DETAILS="${CHANGE_DETAILS}### üî¥ Flags Removed ($REMOVE_COUNT)\n"
              REMOVE_LIST=$(echo "$RAW_YAML" | sed -n '/^removals:/,/^[a-z]/p' | grep "^      path:" | sed 's/^      path: flags\./- üî¥ `/' | sed 's/$/`/')
              CHANGE_DETAILS="${CHANGE_DETAILS}${REMOVE_LIST}\n\n"
            fi
            
            # Parse and display modifications
            if [ $MODIFY_COUNT -gt 0 ]; then
              echo "> [!WARNING]" >> $GITHUB_STEP_SUMMARY
              echo "> ### üü° Flags Modified ($MODIFY_COUNT)" >> $GITHUB_STEP_SUMMARY
              echo "> The following flags have **different configurations** between manifests:" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              
              # Extract modified flag names
              echo "<ul>" >> $GITHUB_STEP_SUMMARY
              echo "$RAW_YAML" | sed -n '/^modifications:/,/^[a-z]/p' | grep "^      path:" | sed 's/^      path: flags\./<li>üü° <code>/' | sed 's/$/<\/code><\/li>/' >> $GITHUB_STEP_SUMMARY
              echo "</ul>" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              
              # Build for PR comment
              CHANGE_DETAILS="${CHANGE_DETAILS}### üü° Flags Modified ($MODIFY_COUNT)\n"
              MODIFY_LIST=$(echo "$RAW_YAML" | sed -n '/^modifications:/,/^[a-z]/p' | grep "^      path:" | sed 's/^      path: flags\./- üü° `/' | sed 's/$/`/')
              CHANGE_DETAILS="${CHANGE_DETAILS}${MODIFY_LIST}\n"
            fi
            
            # Export change details for PR comment
            echo "CHANGE_DETAILS<<EOF" >> $GITHUB_ENV
            echo -e "$CHANGE_DETAILS" >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
            
            # Add configuration section (collapsible)
            echo "## Configuration" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "<details>" >> $GITHUB_STEP_SUMMARY
            echo "<summary>View configuration details</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Parameter | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| **Local Manifest** | \`${{ inputs.manifest }}\` |" >> $GITHUB_STEP_SUMMARY
            
            # Determine and display the against source
            if [[ "${{ inputs.against }}" =~ :// ]] || [[ "${{ inputs.against }}" =~ ^[^/]+:[^/] ]]; then
              echo "| **Against Source** | \`${{ inputs.against }}\` |" >> $GITHUB_STEP_SUMMARY
            else
              # Git mode - show branch and path
              if [ -n "${{ github.base_ref }}" ]; then
                TARGET_BRANCH="${{ github.base_ref }}"
              elif [ -n "${{ inputs.base-branch }}" ]; then
                TARGET_BRANCH="${{ inputs.base-branch }}"
              else
                TARGET_BRANCH="main"
              fi
              
              if [ -z "${{ inputs.against }}" ]; then
                REMOTE_PATH="${{ inputs.manifest }}"
              else
                REMOTE_PATH="${{ inputs.against }}"
              fi
              
              echo "| **Against Source** | Branch \`$TARGET_BRANCH\` at \`$REMOTE_PATH\` |" >> $GITHUB_STEP_SUMMARY
            fi
            
            echo "| **Strict Mode** | \`${{ inputs.strict }}\` |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Add manifest diff section (collapsible)
            echo "## üîÑ Manifest Diff" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "<details>" >> $GITHUB_STEP_SUMMARY
            echo "<summary>View unified diff between manifests</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```diff' >> $GITHUB_STEP_SUMMARY
            # Generate unified diff between the two manifest files
            # Use diff -u for unified format, which works well with GitHub's diff syntax
            # Suppress exit code in case files are identical or diff fails
            MANIFEST_DIFF=$(diff -u "${{ inputs.against-manifest-path }}" "${{ inputs.manifest }}" | tail -n +3 || true)
            echo "$MANIFEST_DIFF" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Export diff for PR comment
            echo "MANIFEST_DIFF<<EOF" >> $GITHUB_ENV
            echo "$MANIFEST_DIFF" >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
            
            # Add expandable raw YAML output
            echo "## üìÑ Raw Output" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "<details>" >> $GITHUB_STEP_SUMMARY
            echo "<summary>Click to expand raw YAML comparison output</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```yaml' >> $GITHUB_STEP_SUMMARY
            echo "$RAW_YAML" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
          fi
        else
          # Success banner
          echo "> [!NOTE]" >> $GITHUB_STEP_SUMMARY
          echo "> ‚úÖ **All Clear!** - Your local manifest is perfectly in sync with the against source" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üéâ Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "No differences were detected. Your flag configurations are synchronized! üöÄ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Add configuration section (collapsible) for success case
          echo "## Configuration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "<details>" >> $GITHUB_STEP_SUMMARY
          echo "<summary>View configuration details</summary>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Parameter | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Local Manifest** | \`${{ inputs.manifest }}\` |" >> $GITHUB_STEP_SUMMARY
          
          # Determine and display the against source
          if [[ "${{ inputs.against }}" =~ :// ]] || [[ "${{ inputs.against }}" =~ ^[^/]+:[^/] ]]; then
            echo "| **Against Source** | \`${{ inputs.against }}\` |" >> $GITHUB_STEP_SUMMARY
          else
            # Git mode - show branch and path
            if [ -n "${{ github.base_ref }}" ]; then
              TARGET_BRANCH="${{ github.base_ref }}"
            elif [ -n "${{ inputs.base-branch }}" ]; then
              TARGET_BRANCH="${{ inputs.base-branch }}"
            else
              TARGET_BRANCH="main"
            fi
            
            if [ -z "${{ inputs.against }}" ]; then
              REMOTE_PATH="${{ inputs.manifest }}"
            else
              REMOTE_PATH="${{ inputs.against }}"
            fi
            
            echo "| **Against Source** | Branch \`$TARGET_BRANCH\` at \`$REMOTE_PATH\` |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "| **Strict Mode** | \`${{ inputs.strict }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "</details>" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "*Generated by [OpenFeature Manifest Compare Action](https://github.com/openfeature/openfeature-action)*" >> $GITHUB_STEP_SUMMARY
        
        echo "::endgroup::"

    - name: Post PR comment
      if: |
        github.event_name == 'pull_request' && 
        steps.compare.outputs.has-differences == 'true' && 
        inputs.post-pr-comment == 'true'
      uses: marocchino/sticky-pull-request-comment@v2
      with:
        header: openfeature-manifest-compare-${{ hashFiles(inputs.manifest) }}
        message: |
          ## üöÄ OpenFeature Manifest Comparison
          
          > [!WARNING]
          ${{ (contains(inputs.against, '://') || contains(inputs.against, ':')) && 
              format('> **Out of Sync with Upstream** - Your local manifest (`{0}`) differs from the remote source (`{1}`)', inputs.manifest, inputs.against) || 
              format('> **Git Changes Detected** - Your feature flag manifest has changes compared to the {0} branch', 
                     github.base_ref || inputs.base-branch || 'main') }}
          
          ### üìä Change Summary
          
          | Change Type | Count | Description |
          |-------------|-------|-------------|
          | üü¢ **Additions** | **${{ env.ADD_COUNT }}** | New flags added |
          | üî¥ **Removals** | **${{ env.REMOVE_COUNT }}** | Flags removed |
          | üü° **Modifications** | **${{ env.MODIFY_COUNT }}** | Flags modified |
          | **Total** | **${{ env.TOTAL_CHANGES }}** | Total differences |
          
          <details>
          <summary>üìã View detailed changes</summary>
          
          ${{ env.CHANGE_DETAILS }}
          
          </details>
          
          <details>
          <summary>üîÑ View manifest diff</summary>
          
          ```diff
          ${{ env.MANIFEST_DIFF }}
          ```
          
          </details>
          
          ---
          ${{ (contains(inputs.against, '://') || contains(inputs.against, ':')) && 
              '*‚ö†Ô∏è Consider syncing with your upstream flag provider to avoid configuration drift*' || 
              '*üìù This comparison shows changes introduced in this PR*' }}
          
          *This comment is automatically updated on each push*

    - name: Delete PR comment if no differences
      if: |
        github.event_name == 'pull_request' && 
        steps.compare.outputs.has-differences == 'false' && 
        inputs.post-pr-comment == 'true'
      uses: marocchino/sticky-pull-request-comment@v2
      with:
        header: openfeature-manifest-compare-${{ hashFiles(inputs.manifest) }}
        delete: true

    - name: Handle failure condition
      shell: bash
      run: |
        HAS_DIFFERENCES="${{ steps.compare.outputs.has-differences }}"
        STRICT_MODE="${{ inputs.strict }}"
        
        if [ "$HAS_DIFFERENCES" = "true" ] && [ "$STRICT_MODE" = "true" ]; then
          echo "::error::Manifest differences detected in strict mode"
          exit 1
        fi